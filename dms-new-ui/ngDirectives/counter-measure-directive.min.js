"use strict";define(["angularAMD"],function(e){e.directive("counterMeasure",["$uibModal","$filter",function(e,t){return{restrict:"E",scope:{counterMeasureData:"=",scorecardId:"=",isEditAuthorised:"="},controller:["$scope",function(r){function a(e){e.preventDefault(),e.stopPropagation();var t=this.container.find("[data-role=datepicker]:eq(0)").data("kendoDatePicker").value(),r=this.container.find("[data-role=datepicker]:eq(1)").data("kendoDatePicker").value();n(this.dataSource,this.field),o(this.dataSource,this.field,t,r),this.popup.close()}function i(e){e.preventDefault(),e.stopPropagation(),n(this.dataSource,this.field),this.popup.close()}function o(e,t,r,a){var i={field:t,logic:"and",filters:[{field:t,operator:"gte",value:r},{field:t,operator:"lte",value:a}]},o=e.filter()||{logic:"and",filters:[]};if("or"==o.logic){var n={logic:"and",filters:[]};n.filters.push(o),n.filters.push(i),o=n}else o.filters.push(i);e.filter(o)}function n(e,t){var r=e.filter();if(r){var a=$.grep(r.filters,function(e){return e.field===t});angular.forEach(a,function(e){var t=r.filters.indexOf(e);r.filters.splice(t,1)}),e.filter(r)}}var l=this;r.counterMeasure={},r.toolTipOptions={filter:"th:last",position:"bottom"};var c=function(e,t){var r=t.thead.find('[data-field="counterMeasureStatusId"]').data("kendoFilterMultiCheck");r.container.empty(),r.checkSource.sort({field:e.field,dir:"asc"}),r.checkSource.data(r.checkSource.view().toJSON()),r.createCheckBoxes()},u=function(e,t){var r=t.thead.find('[data-field="'+e.field+'"]').data("kendoFilterMultiCheck");r.container.empty(),r.checkSource.sort({field:e.field,dir:"asc"}),r.checkSource.data(r.checkSource.view().toJSON()),r.createCheckBoxes()},s=function(e,t){var r={container:e.container,popup:e.container.data("kendoPopup"),dataSource:t.dataSource,field:e.field};d(r)},d=function(e){e.container.off(),e.container.empty();var t=kendo.template($("#counterMeasureDateFilterTemplate").html()),r=t({});e.container.html(r),e.container.find(".date-from").kendoDatePicker(),e.container.find(".date-to").kendoDatePicker(),e.container.find(".date-from").attr("readonly",!0),e.container.find(".date-to").attr("readonly",!0),e.container.on("submit",$.proxy(a,e)).on("reset",$.proxy(i,e))},f=function(){l.gridOptions={sortable:!0,scrollable:!0,filterable:{operators:{string:{startswith:"Starts With",contains:"Contains"}}},filterMenuInit:function(e){"counterMeasureStatusName"===e.field?c(e,this):"openedDate"==e.field||"dueDate"==e.field?s(e,this):"issue"!=e.field&&"action"!=e.field&&u(e,this)},columns:[{field:"metricName",title:"Metric",filterable:{multi:!0}},{field:"counterMeasurePriorityName",title:"Priority",filterable:{multi:!0}},{field:"issue",title:"Issue",filterable:{extra:!1}},{field:"openedDate",title:"Opened"},{field:"action",title:"Actions",filterable:{extra:!1}},{field:"assignedUserName",title:"Who",filterable:{multi:!0}},{field:"dueDate",title:"Due"},{field:"counterMeasureStatusId",title:"Status",filterable:{field:"counterMeasureStatusName",multi:!0}},{field:"commentsCount",title:"Comments",headerTemplate:'<i class="comments"></i>',filterable:!1,sortable:!1}],noRecords:{template:"No results to show"},rowTemplate:kendo.template($("#counterMeasureRowTemplate").html())}};r.$watch("counterMeasureData",function(){if(void 0!==r.counterMeasureData&&r.counterMeasureData.length>0)for(var e=0;e<r.counterMeasureData.length;e++)r.counterMeasureData[e].isEditFromTable=!0;p()});var p=function(){f(),l.counterMeasureData=new kendo.data.DataSource({data:r.counterMeasureData,schema:{model:{fields:{openedDate:{type:"date"},dueDate:{type:"date"},counterMeasureStatusId:{type:"number"}}}}})};r.editCounterMeasure=function(a){var i=t("filter")(r.counterMeasureData,{id:a.id},!0)[0];e.open({templateUrl:"ngViews/counter-measure/partials/counter-measure-popup.min.html",controller:"counterMeasureController",controllerUrl:"ngControllers/counter-measure/counter-measure-controller.min",controllerAs:"ctrl",windowClass:"counter-measure-popup",backdrop:"static",keyboard:!1,resolve:{actualData:function(){return r.scorecardData={},r.scorecardData.scorecardId=r.scorecardId,r.scorecardData.isUserAuthorisedToEdit=r.isEditAuthorised,r.scorecardData},counterMeasure:function(){return i},metricDetails:null}}).result.then(function(e){var t=r.counterMeasureData.indexOf(i);r.counterMeasureData[t]=e,r.counterMeasureData[t].isEditFromTable=!0,p()})}}],controllerAs:"ctrl",templateUrl:"ngViews/kpIs/templates/counter-measure.tpl.min.html",link:function(e,t,r){}}}])});