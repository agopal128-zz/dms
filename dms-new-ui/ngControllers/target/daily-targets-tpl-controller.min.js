"use strict";define(["angularAMD"],function(a){a.controller("dailyTargetController",["$scope","$uibModalInstance","monthTarget","targetParams","monthlyTargetId","mode","targetService","notificationService","confirmationModalService","configService","utilityService",function(a,t,e,l,r,n,o,i,g,y,T){var u=this,s=y.getUIResources("Target");u.mode=e.isPastMonth?"view":n,u.monthlyTarget={},u.showRolledUpTarget=!1,u.dailyTargets=[],u.dynamicPopover={targets:e},u.isEditMode="manage"===u.mode,l.showDailyAndMonthly?0===e.targetEntryMethod?(u.isTargetEntryDaily=null==e.goalValue||""==e.goalValue,u.isTargetEntryMonthly=null!=e.goalValue&&""!=e.goalValue):(u.isTargetEntryDaily=null!=e.dailyRateValue&&""!=e.dailyRateValue,u.isTargetEntryMonthly=null!=e.goalValue&&""!=e.goalValue):(u.isTargetEntryDaily=0===e.targetEntryMethod,u.isTargetEntryMonthly=1===e.targetEntryMethod),u.metricDataType=l.metricDataTypeId,u.metricDataTypeName=0==u.metricDataType?"wholeNumber":"decimal",u.calculateSumofDailyTargets=function(a){a||(a=u.dailyTargets);var t=0;return a.forEach(function(a){t+=a.goalValue}),Math.round(100*t)/100},u.checkDailyTargetsAgainstMonthlyTargets=function(){var a=u.calculateSumofDailyTargets();return a==u.monthlyTarget.goalValue},u.applyDailyRate=function(){u.dailyTargets.forEach(function(a){a.isHoliday||a.isOutofRange||(a.goalValue=u.monthlyTarget.dailyRateValue)})},u.cancel=function(){t.dismiss("cancel")},u.ok=function(){if(u.isTargetEntryMonthly)if(u.checkDailyTargetsAgainstMonthlyTargets())u.monthlyTarget.dailyTargets=u.dailyTargets,t.close(u.monthlyTarget);else{var a=g.openConfirmationModal("md",s.checkDailyTargetAgainstMonthlyTarget.format(u.calculateSumofDailyTargets()));a.result.then(function(){u.monthlyTarget.goalValue=u.calculateSumofDailyTargets(),u.monthlyTarget.dailyTargets=u.dailyTargets,t.close(u.monthlyTarget)},function(){})}else u.monthlyTarget.dailyTargets=u.dailyTargets,t.close(u.monthlyTarget)};var c=function(a){o.getDailyTargets(a).then(function(a){a&&(u.dailyTargets=a,u.isEditMode&&m(u.dailyTargets)!=d(e.month.year,e.month.id)&&h(l,e))},function(a){})},h=function(a,t){o.generateDailyTargets(a,t).then(function(a){a&&(u.dailyTargets=a)},function(a){})},d=function(a,t){var e=new Date(a,t-1,1),r=e.getFullYear(),n=e.getMonth(),o=T.convertToDateWithoutTimezone(new Date(l.effectiveStartDate)),i=T.convertToDateWithoutTimezone(new Date(l.effectiveEndDate)),g=new Date(r,n+1,0).getDate();return o.getMonth()==n&&o.getFullYear()==r?g=g-o.getDate()+1:i.getMonth()==n&&i.getFullYear()==r&&(g=i.getDate()),g},m=function(a){var t=$.grep(a,function(a){return 0==a.isOutofRange}).length;return t},f=function(){u.monthlyTarget.goalValue=e.goalValue,u.monthlyTarget.rolledupGoalValue=e.rolledupGoalValue,u.monthlyTarget.dailyRateValue=e.dailyRateValue,u.monthlyTarget.hasManualTarget=e.hasManualTarget,u.monthlyTarget.isManualTarget=e.isManualTarget,u.monthlyTarget.hasDailyTarget=e.hasDailyTarget,u.monthlyTarget.hasRolledUpDailyTarget=e.hasRolledUpDailyTarget,u.isEditMode?e.dailyTargets&&0!==e.dailyTargets.length?m(e.dailyTargets)!=d(e.month.year,e.month.id)?h(l,e):0==l.targetEntryMethod?u.dailyTargets=e.dailyTargets:1==l.targetEntryMethod&&(e.goalValue!=u.calculateSumofDailyTargets(e.dailyTargets)?h(l,e):u.dailyTargets=e.dailyTargets):r&&u.monthlyTarget.hasDailyTarget&&!u.monthlyTarget.isManualTarget?c(r):u.monthlyTarget.hasDailyTarget&&!u.monthlyTarget.isManualTarget||h(l,e):r&&c(r)};(function(){f()})()}])});