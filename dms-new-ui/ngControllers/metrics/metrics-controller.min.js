"use strict";define(["angularAMD","metricsService","uiSelect","uiSelectWrap"],function(e){e.controller("MetricsController",["metricsService","validationService","notificationService","configService","$scope","$q","$rootScope",function(e,i,t,a,n,o,d){var r=this,l=a.getUIResources("Metrics");r.metric=[],r.metricData=[],r.goalTypes=[],r.dataTypes=[],r.metricLoaded=!1,d.title="Add  Metric",d.kpiOwners=[],d.scorecardId="",r.isActiveOptions=[{id:1,name:"Active"},{id:2,name:"Inactive"}],r.addNewRow=function(){r.gridOptions.data.unshift({id:"",name:"",dataType:"",goalType:"",isActive:""})},r.refreshData=function(){r.gridOptions.data.length=0,r.metricLoaded=!1,c()},r.metricColumnDefs=[{name:"id",displayName:"Id",field:"id",enableCellEdit:!1,visible:!1},{name:"name",displayName:"Metric Name",field:"name",enableCellEdit:!0,validators:{required:!0},enableHiding:!1,width:"35%",enableSorting:!0,filter:{placeholder:"Search"}},{name:"dataType",displayName:"Data Type",enableCellEdit:!0,width:"30%",cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.dataType.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",enableSorting:!1,enableColumnMenu:!1,enableFiltering:!1},{name:"goalType",displayName:"Goal Type",enableCellEdit:!0,width:"20%",cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.goalType.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownValueLabel:"name",editDropdownIdLabel:"id",enableSorting:!1,enableColumnMenu:!1,enableFiltering:!1},{name:"isActive",displayName:"Status",enableCellEdit:!0,width:"15%",cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.isActive.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownValueLabel:"name",editDropdownIdLabel:"id",enableSorting:!1,enableColumnMenu:!1,enableFiltering:!1}],r.validationRules={Name:[new ValidationRule(validationType.required,(!0),l.RequiredMetricName)]};var c=function(){e.getAllMetrics().then(function(e){r.metricData=e.reverse(),r.metricData=$.grep(r.metricData,function(e){return e.isActive={id:e.isActive===!0?1:2,name:e.isActive===!0?"Active":"Inactive"},e.isActive}),r.gridOptions.data=r.metricData,r.metricLoaded=!0},function(e){t.notify(e.message[0],{type:"danger"})})};r.getLookupData=function(){e.getMetricTemplateData().then(function(e){r.dataTypes=e.dataTypes,r.goalTypes=e.goalTypes,s()},function(e){t.notify(e.Errors[0],{type:"danger"})})};var s=function(){r.gridOptions.columnDefs[2].editDropdownOptionsArray=r.dataTypes,r.gridOptions.columnDefs[3].editDropdownOptionsArray=r.goalTypes,r.gridOptions.columnDefs[4].editDropdownOptionsArray=r.isActiveOptions};r.gridOptions={rowHeight:38,data:r.metricData,columnDefs:r.metricColumnDefs,enableRowSelection:!0,enableRowHeaderSelection:!1,enableFiltering:!0},r.setMetricData=function(e){r.metric.push({id:e.id,dataType:{id:e.dataType.id},goalType:{id:e.goalType.id},name:e.name,isActive:2!==parseInt(e.isActive.id)})};var p=function(e){r.addOperation=""===e};r.saveRow=function(i){r.metricLoaded=!1,r.setMetricData(i),p(r.metric[0].id);var a=o.defer();r.gridApi.rowEdit.setSavePromise(i,a.promise),e.addOrUpdateMetric(r.metric).then(function(e){a.resolve(),r.addOperation?t.notify(l.AddedSuccessfully,{type:"success"}).then(function(){r.gridOptions.data.length=0,c()},function(e){}):t.notify(l.UpdatedSuccessfully,{type:"success"}).then(function(){r.gridOptions.data.length=0,c()},function(e){})},function(e){a.resolve(),t.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})}),r.metric=[]},r.gridOptions.onRegisterApi=function(e){r.gridApi=e,e.rowEdit.on.saveRow(n,r.saveRow)};(function(){r.getLookupData(),c()})()}])});