"use strict";var totalDepth=null,rootData,MoveUpRef,MoveDownRef,toggleActiveRef,setRootRef,activeMode,toggleFlg,clickedEle,updateLocationRef,hierarchyChartHelper=function(e,t,r,n,i){function a(e,t){if(e){var r=t(e);if(r){f=Math.max(f,r.length);for(var n=r.length,i=0;i<n;i++)a(r[i],t)}}}function c(e){var t=0;return e.children&&e.children.forEach(function(e){var r=c(e);r>t&&(t=r)}),1+t}function l(e){a(e,function(e){return e.children&&e.children.length>0?e.children:null}),v=f>4?Math.max(window.innerHeight,100*f):window.innerHeight,o=Math.min(y/(totalDepth+.5),y/5),s=e,u=e,h=u.drillDownLevel?4*u.drillDownLevel:0;var t=v/2*h;t<=0&&(t=30),p=d3.select("#tree").append("svg").attr("width","100%").attr("height",v).append("g").attr("transform","translate(100,"+t+")").sort(function(e,t){return d3.ascending(e.id,t.id)})}function d(){d3.select(p.node().parentNode).attr("height",0)}rootData=angular.copy(e);var o,s,u,p,h,f=0,v=0,g=0,_=null,x=400;totalDepth||(totalDepth=c(e));var y=$("#tree").width(),w=750,b=window.innerWidth>1900?24:18,g=($("base:first").attr("href"),0),_=null,x=400,m=d3.layout.tree().nodeSize([73,20]).separation(function(e,t){return e.parent==t.parent?1:2}),A=d3.svg.diagonal().projection(function(e){return[e.y+20,e.x]}),k=function(e){e.children&&(e._children=e.children,e._children.forEach(k),e.children=null)},S=function(e){if(e.isRootNode)return e;if(e.children)for(var t in e.children){var r=e.children[t];r._parent=e,r.parent=null;var n=S(r);if(n)return n}return null},D=function(e){var t;if(e.expandTillDrilldownLevel)return t=e.parent?e.parent:e._parent?e._parent:e;if(e.children)for(var r in e.children){var n=e.children[r];n._parent=e,n.parent=null;var i=D(n);if(i)return i}return null},M=function(e,t){if(e){var r=t(e);if(r){r.sort(function(e,t){return d3.ascending(e.sortOrder,t.sortOrder)});for(var n=r.length,i=0;i<n;i++)M(r[i],t)}}},R=function(e,t){if(e.id==t)return e;if(e.children)for(var r in e.children){var n=e.children[r],i=R(n,t);if(i)return i}return null},E=function(e){ne();var t,r,n=R(u,e);if(n.parent.children)for(var i in n.parent.children)if(t=n.parent.children[parseInt(i)+1],r=n.parent.children[i],r==n){L(r,t,n);break}},T=function(e){ne();var t,r,n=R(u,e);if(n.parent.children)for(var i in n.parent.children)if(t=n.parent.children[i-1],r=n.parent.children[i],r==n){L(t,r,n);break}},L=function(e,t,r){var a={swapFrom:{id:e.id,sortOrder:e.sortOrder},swapTo:{id:t.id,sortOrder:t.sortOrder}};n.changeSortOrder(a).then(function(){e.sortOrder<r.parent.children.length&&(e.sortOrder=a.swapTo.sortOrder),t&&t.sortOrder>1&&(t.sortOrder=a.swapFrom.sortOrder),X(r),q()},function(e){i.notify(e.errors.join("</br>"),{autoclose:!1,type:"danger"})})},I=function(e){r.path(e),t.$apply()},O=function(e,t,r){if(!(e<1)&&t){e--;var n=r(t);if(n){n.forEach(function(e){e.children=e._children});for(var i=n.length,a=0;a<i;a++)O(e,n[a],r)}}},C=function(e){if(e.scorecardStatus)switch(e.scorecardStatus){case 1:if(!e._children&&!e.children)return"#28a714";if(e.children)return"#28a714";if(e._children)return e._children.length>0?"#178500":"#28a714";case 2:if(!e._children&&!e.children)return"#f84839";if(e.children)return"#f84839";if(e._children)return e._children.length>0?"#d51700":"#f84839";case 3:if(!e._children&&!e.children)return"#ffb700";if(e.children)return"#ffb700";if(e._children)return e._children.length>0?"#d29700":"#ffb700";case 4:if(!e._children&&!e.children)return"#bbbbbb";if(e.children)return"#bbbbbb";if(e._children)return e._children.length>0?"#606060":"#bbbbbb"}else{if(!e._children&&!e.children)return"#84ABDE";if(e.children)return"#84ABDE";if(e._children)return e._children.length>0?"#1C8CC5":"#84ABDE"}},F=function(e,t){if(e){var r=t(e);if(e._children&&e._children.forEach(function(e){if(!e.isActive){k(e);var t;e.parent?t=e.parent:e._parent&&(t=e._parent),e._siblings&&(t._children=e._siblings,e._siblings=null),t._inactive||(t._inactive=[]),t._inactive.indexOf(e)==-1&&t._inactive.push(e),t._children=t._children.filter(function(t){return t!=e})}}),r){r.forEach(function(e){if(!e.isActive){k(e);var t;e.parent?t=e.parent:e._parent&&(t=e._parent),e._siblings&&(t._children=e._siblings,e._siblings=null),t.inactive||(t.inactive=[]),t.inactive.indexOf(e)==-1&&t.inactive.push(e),t.children&&(t.children=t.children.filter(function(t){return t!=e})),t._children&&(t._children=t._children.filter(function(t){return t!=e}))}});for(var n=r.length,i=0;i<n;i++)F(r[i],t)}}},N=function(e,t){if(e){e.inactive?(e.children?1==e.children.length&&e.children[0]._siblings&&e.children[0]._siblings.length?e.children[0]._siblings=e.children[0]._siblings.concat(e.inactive):e.children=e.children.concat(e.inactive):e._children?e._children=e._children.concat(e.inactive):e.children=e.inactive,e.inactive=null):e._inactive&&(e.children?1==e.children.length&&e.children[0]._siblings&&e.children[0]._siblings.length?e.children[0]._siblings=e.children[0]._siblings.concat(e._inactive):e.children=e.children.concat(e._inactive):e._children?e._children=e._children.concat(e._inactive):e.children=e.inactive,e._inactive=null);var r=[];e.children&&($.each(e.children,function(e,t){$.inArray(t,r)===-1&&r.push(t)}),e.children=r);var n=[];e._children&&($.each(e._children,function(e,t){$.inArray(t,n)===-1&&n.push(t)}),e._children=n);var i=t(e);if(i)for(var a=i.length,c=0;c<a;c++)N(i[c],t)}},W=function(t){if(activeMode=t,t){if(!u.isActive)return void j(!0);F(e,function(e){return e.children&&e.children.length>0?e.children:e._children&&e._children.length>0?e._children:null})}else{if(toggleFlg=!0,!u.isActive)return void j(!1);N(e,function(e){return e.children&&e.children.length>0?e.children:e._children&&e._children.length>0?e._children:null})}X(u),q()},V=function(e,t){if(e.id==t)return e;if(e.children)for(var r in e.children){var n=e.children[r];if("object"==typeof n)var i=V(n,t);if(i)return i}return null},B=function(e){u=S(e),u||(e=angular.copy(rootData),u=D(e)),u||(e=angular.copy(rootData),u=e)},U=function(t,r,n){e=angular.copy(rootData),B(e),u.isRootNode&&(u.isRootNode=!1),u.expandTillDrilldownLevel?u.expandTillDrilldownLevel=!1:u.children.forEach(function(e){e.expandTillDrilldownLevel=!1});var i=V(e,t);i&&(i.expandTillDrilldownLevel=!0);var a=V(e,r);a?a.isRootNode=!0:i&&(i.isRootNode=!0),j(n)},j=function(r){if(activeMode=r,$("#tree").empty(),!e)return t.isRootNodeInactive=!0,void d();m.nodes(e).reverse();if(l(e),B(e),u.isActive?t.isRootNodeInactive=!1:t.isRootNodeInactive=!0,!u||!u.isActive&&r)return void d();u.x0=v/2,u.y0=0,r&&W(!0);var n=2;if(u.expandTillDrilldownLevel&&null!=u.drillDownLevel)n=u.drillDownLevel-1;else if(u.children)for(var i=0;i<u.children.length;i++){var a=u.children[i];if(a.expandTillDrilldownLevel&&null!=a.drillDownLevel){n=a.drillDownLevel;break}}if(n||0==n||(n=2),n>0&&!u.children&&u._children&&(u.children=u._children),u.children&&u.children.forEach(k),n<0&&k(u),O(n,u,function(e){return e.children&&e.children.length>0?e.children:null}),!u.expandTillDrilldownLevel&&u.children)for(var i=0;i<u.children.length;i++){var a=u.children[i];a.expandTillDrilldownLevel&&null!=a.drillDownLevel&&a.parent.children.forEach(function(e){e!=a&&k(e)})}X(u),q()},P=function(e){toggleFlg&&(toggleFlg=!1),v=p.node().getBBox().height;var t=-p.node().getBBox().y;d3.select(p.node().parentNode).transition().ease("quad").attr("height",v),d3.select(p.node()).transition().ease("quad").attr("transform","translate(100,"+t+")"),e()},H=function(e,t){e.each(function(e){for(var r,n=d3.select(this),i=e.name.split(/\s+/).reverse(),a=0,c=[],e=n.attr("x"),l=n.attr("y"),d=0,o=n.text(null).append("tspan").attr("x",e).attr("y",l).attr("dy",d+"em");r=i.pop();)c.push(r),o.text(c.join(" ")),o.node().getComputedTextLength()>t&&(a++,c.pop(),o.text(c.join(" ")),c=[r],o=n.append("tspan").attr("x",e).attr("y",parseInt(l)+14*a).text(r))})},q=function(){M(u,function(e){return e.children&&e.children.length>0?e.children:null});var e=m.nodes(u).reverse(),t=m.links(e);e.forEach(function(e){e.y=e.depth*o});var r=p.selectAll("g.node").attr("id",function(e,t){return"node"+t}).data(e,function(e){return e.id}),n=r.enter().append("g").attr("class","node").attr("id",function(e){return e.id}).attr("transform",function(e){var t=s.y0+10,r=s.x0;return toggleFlg&&e.parent&&(e.parent.y0&&(t=e.parent.y0+10),e.parent.x0&&(r=e.parent.x0)),"translate("+t+","+r+")"});n.append("circle").attr("class","node-circle").attr("r",0).style("cursor","pointer").style("fill",function(e){return C(e)}).on({dblclick:G,click:re}),n.append("text").attr("class","edge upEdge fa").attr("height","20px").attr("width","20px").attr("x",function(){return 18==b?"-7":"-8"}).attr("y",function(){return 18==b?"-16":"-21"}).style("fill-opacity","0").text(function(e){return""}).on("click",J),n.append("text").attr("class","edge leftEdge fa").attr("height","20px").attr("width","20px").attr("x",function(){return 18==b?"-34":"-40"}).attr("y","8").text(function(e){return""}).on("click",K),n.append("image").attr("class","fa fa-user userIcon").style("fill",function(e){return"gray"}).attr("height",window.innerWidth>1900?"52px":"40px").attr("width",window.innerWidth>1900?"52px":"40px").attr("x",window.innerWidth>1900?"-26":"-20").attr("y",window.innerWidth>1900?"-26":"-20").attr("xlink:href","Images/user_white.png").on({dblclick:G,click:re}),n.append("image").attr("height","30px").attr("width","30px").attr("x",window.innerWidth>1900?"15":"10").attr("y",window.innerWidth>1900?"-40":"-35").attr("xlink:href",function(e){return null!=e.daysWithoutRecordables?"Images/recordable.png":null}),n.append("text").attr("x",window.innerWidth>1900?"30":"25").attr("y",window.innerWidth>1900?"-20":"-15").attr("class","recordable").attr("dx","0").attr("text-anchor","middle").text(function(e){return null!=e.daysWithoutRecordables?e.daysWithoutRecordables:""}).style("fill-opacity",0),n.append("text").attr("x","0").attr("y",function(e){var t=Y(e)+11;return t}).attr("class","name").attr("dx","0").attr("text-anchor","middle").call(H,179).style("fill-opacity",0),n.append("circle").attr("class","primary-circle").attr("r",10).attr("cx",-33).attr("cy",-3).style("fill",function(e){if(!e.cascadedPrimaryMetricStatus)return"#aaa";switch(e.cascadedPrimaryMetricStatus){case 1:return"#28A714";case 2:return"#F84839"}}),n.append("text").attr("class","primary-text").attr("dx","-31").attr("dy","2").attr("fill","white").text(function(e){return"p"}).attr("text-anchor","middle"),n.append("circle").attr("class","secondary-circle").attr("r",10).attr("cx",-33).attr("cy",-3).style("fill",function(e){if(!e.cascadedSecondaryMetricStatus)return"#aaa";switch(e.cascadedSecondaryMetricStatus){case 1:return"#28A714";case 2:return"#F84839"}}),n.append("text").attr("class","secondary-text").attr("dx","-31").attr("dy","2").attr("fill","white").text(function(e){return"s"}).attr("text-anchor","middle");var i=r.transition().duration(w).attr("transform",function(e){var t=e.y+10;return"translate("+t+","+e.x+")"}).each("end",function(){setTimeout(function(){P(function(){setTimeout(function(){if(clickedEle){var e,t=$(clickedEle).offset().top,r=clickedEle.getBBox().height,n=$(window).height()-210;e=r<n?t-(n/2-r/2):t,$("html, body").animate({scrollTop:e},{easing:"swing",duration:800}),clickedEle=""}},200)})},200)});i.select("circle.primary-circle").style("fill",function(e){if(!e.cascadedPrimaryMetricStatus)return"#aaa";switch(e.cascadedPrimaryMetricStatus){case 1:return"#28A714";case 2:return"#F84839"}}).attr("cx",function(e){return z(e)}),i.selectAll("circle.primary-circle, text.primary-text").attr("display",function(e){return e.hasPrimaryCascaded?"block":"none"}),i.selectAll("text.primary-text").attr("dx",function(e){return z(e)}),i.select("circle.secondary-circle").style("fill",function(e){if(!e.cascadedSecondaryMetricStatus)return"#aaa";switch(e.cascadedSecondaryMetricStatus){case 1:return"#28A714";case 2:return"#F84839"}}).attr("cx",function(e){return 0===e.depth&&e._parent?"-45":0===e.depth?"-36":"-31"}),i.selectAll("circle.secondary-circle, text.secondary-text").attr("display",function(e){return e.hasSecondaryCascaded?"block":"none"}),i.selectAll("text.secondary-text").attr("dx",function(e){return 0===e.depth&&e._parent?"-45":0===e.depth?"-36":"-31"}),i.select("circle.node-circle").attr("r",function(e){return Y(e)}).style("fill",function(e){return C(e)}),i.selectAll("text").style("fill-opacity",1),i.selectAll("text.name").attr("y",function(e){var t=Y(e)+11;return t}).call(H,179),i.selectAll("text.upEdge").style("display",function(e){if(!e.parent&&!e._parent)return"none"}),i.selectAll("text.leftEdge").text(function(e){if(e._parent)return""}).attr("x",function(e){return 18==b?"-34":"-40"}).style("display",function(e){return!activeMode&&e._parent&&!e.parent||activeMode&&e._parent&&e._parent.isActive&&!e.parent?"block":"none"}),i.selectAll("text.upEdge").text(function(e){return e._siblings&&e._siblings.length?"":""}).style("display",function(e){return 0===e.depth?"none":!e._siblings&&e.parent.children&&e.parent.children.length<2?"none":void 0});var a=r.exit().transition().duration(w).attr("transform",function(e){var t=e.parent?parseFloat(e.parent.y)+10:0,r=e.parent?e.parent.x:0;return"translate("+t+","+r+")"}).remove();a.select("circle.node-circle").attr("r",0),a.selectAll("text").style("fill-opacity",0);var c=p.selectAll("path.link").data(t,function(e){return e.target.id});c.enter().insert("path","g").attr("class","link").attr("d",function(e){var t={x:s.x0,y:s.y0};return toggleFlg&&e.source&&(e.source.x0&&(t.x=e.source.x0),e.source.y0&&(t.y=e.source.y0)),A({source:t,target:t})}),c.transition().duration(w).attr("d",A),c.exit().transition().duration(w).attr("d",function(e){var t={x:e.target.parent?e.target.parent.x:0,y:e.target.parent?e.target.parent.y:0};return A({source:t,target:t})}).remove(),e.forEach(function(e){e.x0=e.x,e.y0=e.y})},z=function(e){var t;return t=0===e.depth&&e._parent?-45:0===e.depth?-36:-31,e.hasSecondaryCascaded&&(t-=22),t},X=function(e){s=e},Y=function(e){return 0===e.depth?b+5:b},G=function(e){e.canViewScorecard&&I("Scorecard/"+e.id)},J=function(e){d3.select(this.parentNode);ne(),e._siblings?(e._siblings.forEach(function(t){t.id!=e.id&&k(t)}),activeMode&&(e.parent._inactive||(e.parent._inactive=[]),e._siblings=e._siblings.filter(function(t){return t.isActive||e.parent._inactive.indexOf(t)!=-1||e.parent._inactive.push(t),t.isActive})),e.parent?(e.parent.children=e._siblings,e._siblings=null):e._parent&&(e._parent.children=e._siblings,e._siblings=null)):e.parent&&e.parent.children?(e._siblings=e.parent.children,e.parent._inactive?e._siblings=e._siblings.concat(e.parent._inactive):e.parent.inactive&&(e._siblings=e._siblings.concat(e.parent.inactive)),e.parent.children=[],e.parent.children.push(e),e.parent._inactive=e.parent.inactive=null):e._parent&&e._parent.children&&(e._siblings=e._parent.children,e._parent._inactive?e._siblings=e._siblings.concat(e._parent._inactive):e._parent.inactive&&(e._siblings=e._siblings.concat(e._parent.inactive)),e._parent.children=[],e._parent.children.push(e),e._parent._inactive=e._parent.inactive=null),X(e),q()},K=function(e){if(ne(),e.parent);else if(e._parent){for(e.parent=e._parent,e._parent=null,u=e.parent;e.parent.parent;)e.parent._parent=e.parent.parent,e.parent.parent=null;e._siblings||(e._siblings=e.parent.children,e.parent.children=[],e.parent.children.push(e)),X(e),q()}},Q=function(e){var t,r;if(e.parent&&e.parent.children)for(var n=0;n<e.parent.children.length;n++)(!t||parseInt(e.parent.children[n].sortOrder)>parseInt(t.sortOrder))&&(t=e.parent.children[n]),(!r||parseInt(e.parent.children[n].sortOrder)<parseInt(r.sortOrder))&&(r=e.parent.children[n]);return{min:r,max:t}},Z=function(e,t){if(e.classed("clicked"))ne();else{ne(),e.classed("clicked",!0);var r={x:d3.event.pageX,y:d3.event.pageY};if(t.canViewScorecard){var n=Q(t);setTimeout(function(){var e=(t.id,t.name,!!t.parent),i=!!e&&t.parent.id;0!==$("#context-menu").length&&$(".icon-wrapper").is(":visible")?ae():d3.select("#tree").append("div").attr("class","icon-wrapper").attr("id","context-menu").html((t.canViewScorecard?'<a id="viewScoreCard" data-scorecard-id="'+t.id+'" title="View" class="fa fa-eye"> <span>View Scorecard</span></a><br/>':"")+(t.canAddScorecard?'<a id="addScoreCard" data-scorecard-id="'+t.id+'" data-scorecard-parentId="'+i+'" title="Add" class="fa fa-plus"><span> Add Scorecard</span></a><br/>':"")+(t.canEditScorecard?'<a id="editScoreCard" data-scorecard-id="'+t.id+'" data-scorecard-parentId="'+i+'" title="Edit" class="fa fa-pencil"> <span>Edit Scorecard</span></a><br/>':"")+(t.canManageTarget?'<a id="manageTargets" data-scorecard-id="'+t.id+'" data-scorecard-parentId="'+i+'" title="Manage" class="fa fa-bullseye"><span> Manage Targets</span></a>':"")+(t.canViewTargets?'<a id="viewTarget" data-scorecard-id="'+t.id+'" data-scorecard-parentId="'+i+'" title="View" class="fa fa-bullseye"> <span>View Targets</span></a>':"")+(t.canReOrder&&t!=n.min&&n.min!=n.max?'<a id="moveUp" data-scorecard-id="'+t.id+'" data-scorecard-parentId="'+i+'" title="MoveUp" class="fa fa-arrow-up"> <span>Move Up</span></a><br/>':"")+(t.canReOrder&&t!=n.max&&n.min!=n.max?'<a id="moveDown" data-scorecard-id="'+t.id+'" data-scorecard-parentId="'+i+'" title="MoveDown" class="fa fa-arrow-down"> <span>Move Down</span></a><br/>':"")).style("left",r.x+39+"px").style("top",r.y-11+"px").style("cursor","pointer")},400)}}},ee=function(e,t){t.canViewScorecard&&e.append("text").attr("class","edge options").attr("id","showMenu").attr("height","20px").attr("width","20px").attr("x",function(){return Y(t)-1}).attr("y","8").text(function(e){return""}).on("click",function(){Z(e,t)})},te=function(e,t){ne(),e.children?(e._children=e.children,e.children=null):(clickedEle=t,e.children=e._children,e._children=null),X(e),q()},re=function(e){var t=this.parentNode,r=d3.select(t);g++,1===g?_=setTimeout(function(){ie(),te(e,t),setTimeout(function(){ee(r,e)},450),g=0},x):(clearTimeout(_),g=0)},ne=function(){d3.select("div.icon-wrapper").remove(),d3.selectAll("text.userIcon").style("fill","gray"),d3.selectAll("g.node").classed("clicked",!1)},ie=function(){d3.select("text.options").remove(),d3.select("div.icon-wrapper").remove(),d3.selectAll("text.userIcon").style("fill","gray"),d3.selectAll("g.node").classed("clicked",!1)},ae=function(){d3.select("div.icon-wrapper").remove()};return MoveUpRef=T,MoveDownRef=E,toggleActiveRef=W,setRootRef=U,updateLocationRef=I,{draw:j}};$(document).ready(function(){$(document).on("click","#moveUp",function(){MoveUpRef($(this).attr("data-scorecard-id"))}),$(document).on("click","#moveDown",function(){MoveDownRef($(this).attr("data-scorecard-id"))}),$(document).on("click","#viewScoreCard",function(){var e="Scorecard/"+$(this).attr("data-scorecard-id");updateLocationRef(e)}),$(document).on("click","#addScoreCard",function(){var e="ScorecardAdmin/Add/"+$(this).attr("data-scorecard-id");updateLocationRef(e)}),$(document).on("click","#editScoreCard",function(){var e="ScorecardAdmin/Edit/"+$(this).attr("data-scorecard-id")+"/"+$(this).attr("data-scorecard-parentId");updateLocationRef(e)}),$(document).on("click","#manageTargets",function(){var e="Targets/Manage/Edit/"+$(this).attr("data-scorecard-id")+"/"+$(this).attr("data-scorecard-parentId");updateLocationRef(e)}),$(document).on("click","#viewTarget",function(){var e="Targets/Manage/View/"+$(this).attr("data-scorecard-id")+"/"+$(this).attr("data-scorecard-parentId");updateLocationRef(e)})}),$(document).click(function(e){$(e.target).closest(".icon-wrapper").length||$(e.target).is(".icon-wrapper")||$(e.target).closest(".node").length||$(e.target).is(".node")||$(".icon-wrapper").is(":visible")&&($(".icon-wrapper").remove(),d3.selectAll("g.node").classed("clicked",!1))});