"use strict";define(["angularAMD","targetService","monthlyPlan","calendar","viewTarget","toggleSwitch","confirmationModalService","dailyTargetController","copyTargetController","validNumber","utilityService"],function(t){t.controller("ManageTargetController",["targetService","confirmationModalService","validationService","notificationService","configService","$routeParams","$filter","$rootScope","$uibModal","$scope","utilityService",function(t,e,a,r,n,i,d,o,c,l,s){var g=this,u=parseInt(i.scorecardId);g.isPrimary=!0,g.isSaving=!1,g.goalEntered=!1,g.canYearChange=!0,g.isMetricExists=!1,g.isMetricEditMode=!1,g.isAddingNewTarget=!1,g.canAddMetricTarget=!0,g.isCascadeFromParent=!1,g.isCascaded=!1,g.isStretchGoalEnabled=!1,g.isPrevCalenderYearSelected=!1,g.isNextCalenderYearSelected=!1,g.isViewTarget="View"==i.mode,g.action="",g.yearId="",g.metricId="",g.metricType="",g.annualTarget="",g.selectedYear="",g.scorecardName="",g.rollupMethodId="",g.effectiveEndDate="",g.effectiveStartDate="",g.isBowlingChartApplicable="",g.cascadedMetricsTrackingMethodId="",g.selectedMetricDataType={},g.years=[],g.targets=[],g.monthlyData=[],g.setMatrics=[],g.setMetricsInDateRange=[],g.kpiTargetData=[],g.monthlyTargets=[],g.metricTypeOptions=[],g.rollupMethodOptions=[],g.trackingMethodOptions=[],g.targetEntryMethodOptions=[],g.trackingMethodOptionsFiltered=[],g.mtdTrackingMethodOptions=[],g.mtdTrackingMethodOptionsFiltered=[],g.trackingMethodId=0,g.graphPlottingMethodId=0,g.targetEntryMethodId=1,g.canCopyMetrics=!0,g.hasMonthlyAndDailyTargets=!1,g.isDataLoaded=!1;var h=n.getUIResources("Target"),f=function(t){return s.convertToDateWithoutTimezone(t)},M=function(){g.targetData={scorecardId:u,kpiId:g.tab,metricId:g.metricId,metricType:g.metricType,cascadeFromParent:g.isCascadeFromParent,isStretchGoalEnabled:g.isStretchGoalEnabled,calendarYearId:g.yearId,effectiveStartDate:d("date")(g.effectiveStartDate,"dd MMM yyyy"),effectiveEndDate:d("date")(g.effectiveEndDate,"dd MMM yyyy"),trackingMethodId:g.trackingMethodId,targetEntryMethodId:g.targetEntryMethodId,graphPlottingMethodId:g.graphPlottingMethodId,mTDPerformanceTrackingMethodId:g.mtdTrackingMethodId,rollupMethodId:g.rollupMethodId,annualTarget:g.annualTarget,monthlyTargets:g.monthlyTargets,cascadedMetricsTrackingMethodId:g.cascadedMetricsTrackingMethodId},1===g.metricType&&(g.ParentMetricData?g.targetData.maximumAllowedMonthlyGoals=g.ParentMetricData.maximumAllowedMonthlyGoals:g.targetData.maximumAllowedMonthlyGoals="")};g.bindYearId=function(t){switch(t){case g.years[0].id:g.isPrevCalenderYearSelected=!0,g.isNextCalenderYearSelected=!1,g.yearId=t;break;case g.years[1].id:g.yearId=t,g.isPrevCalenderYearSelected=!1,g.isNextCalenderYearSelected=!1,g.dateOptions={minDate:g.currentYearMinDate,maxDate:g.currentMaxDate},tt();break;case g.years[2].id:g.yearId=t,g.isPrevCalenderYearSelected=!1,g.isNextCalenderYearSelected=!0,g.dateOptions={minDate:g.nextYearMinDate,maxDate:g.nextMaxDate},g.effectiveStartDate=g.nextYearMinDate,g.effectiveEndDate=g.nextMaxDate}Z(u,g.yearId)};var y=function(t){g.targets=[],g.targetsSecondary=[],angular.forEach(t,function(t){0===t.metricType?g.targets.push(t):g.targetsSecondary.push(t)}),g.targets=g.targets.concat(g.targetsSecondary),g.kpiTargetData.push({targets:g.targets})},m=function(t,e){t&&(!t&&0!==t||2===t)||(g.annualTarget="Year End Target"==g.targetLabelName?"":g.annualTarget,g.targetLabelName="Full Year Target"),t&&2===t&&(e&&"Full Year Target"==g.targetLabelName&&(g.annualTarget=""),g.targetLabelName="Year End Target")},p=function(){g.kpiTargetData&&angular.forEach(g.kpiTargetData[0].targets,function(t,e){if(null!==t.rollupMethodId){var a=$.grep(g.rollupMethodOptions,function(e){return e.id===t.rollupMethodId});a&&(t.rollupMethodName=a[0].name)}t.effectiveStartDate=f(t.effectiveStartDate),t.effectiveEndDate=f(t.effectiveEndDate),angular.forEach(t.monthlyTargets,function(e,a){t.maximumAllowedMonthlyGoals&&(t.monthlyTargets[a].maximumAllowedGoal=t.maximumAllowedMonthlyGoals[a].value)}),!t.metricDataTypeId&&0!==t.metricDataTypeId||2===t.metricDataTypeId||(t.targetLabelName="Full Year Target"),t.metricDataTypeId&&2===t.metricDataTypeId&&(t.targetLabelName="Year End Target")})},D=function(t,e){t||0===t?angular.forEach(g.kpiTargetData[0].targets,function(e,a){e.id==t&&(g.currentExpandedTargetIndex=a)}):(e||0===e)&&angular.forEach(g.kpiTargetData[0].targets,function(t,a){t.metricType==e&&(g.currentExpandedTargetIndex=a)})},T=function(e,a,n){g.kpiTargetData=[],g.setMatrics=[],g.setMetricsInDateRange=[],g.isDataLoaded=!1,g.canYearChange=!1,t.getTargetsForScorecardAndKPI(u,e,g.yearId).then(function(t){g.isDataLoaded=!0,g.canYearChange=!0,t&&t.length?(g.metricData=t,y(t),D(a,n),p(),g.renderingPageUrl="ngViews/targets/partials/view-target.min.html",g.isMetricExists=!0,angular.forEach(g.metricData,function(t,e){g.setMatrics.push({targetId:t.id,metricName:t.metricName,effectiveStartDate:f(t.effectiveStartDate),effectiveEndDate:f(t.effectiveEndDate)})})):(g.isMetricExists=!1,g.metricData=null)},function(t){g.isDataLoaded=!0,g.canYearChange=!0,r.notify(t.errors.join("<br />"),{autoClose:!1,type:"danger"})})};g.isKPIExists=function(t){var e;return g.existingKPIs&&(e=d("filter")(g.existingKPIs,{id:t})[0]),!(!e||void 0===e.id)};var I=function(t,a,r){var n=e.openConfirmationModal("md",h.ChangeTabConfirmationMsg);n.result.then(function(){g.isFormDirty=!1,g.addOrUpdateTargetForm.$setPristine(),g.tab=t,X(),g.canAddMetricTarget=!0,T(t,a,r)},function(){})};g.setTab=function(t,e,a){g.isFormDirty=g.addOrUpdateTargetForm.$dirty,g.isFormDirty?I(t,e,a):(g.tab=t,X(),g.canAddMetricTarget=!g.isFormDirty,T(t,e,a)),e||a||(g.currentExpandedTargetIndex=0)},g.isSet=function(t){return g.tab===t},g.resetMetricsList=function(){t.getMetrics(g.tab,u).then(function(t){t.length&&(g.fullMetrics=t,E(t))},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};var v=function(t){g.setMetricsInDateRange=[],g.validMetrics=[],t?angular.forEach(g.setMatrics,function(t){t.targetId!=g.targetId&&g.validMetrics.push(t)}):g.validMetrics=g.setMatrics,angular.forEach(g.validMetrics,function(t){t.effectiveStartDate<=g.effectiveEndDate&&t.effectiveEndDate>=g.effectiveStartDate&&g.setMetricsInDateRange.push(t.metricName)}),g.metricId&&g.getCascadedMetricDetails()},E=function(t){var e=[];v(g.isMetricEditMode);for(var a=0;a<t.length;a++)if($.inArray(t[a].name,g.setMetricsInDateRange)==-1){var r=d("filter")(t,{name:t.name})[a],n=!1;if(e.length)for(var i=0;i<e.length;i++){if(e[i].id==r.id){n=!0;break}n=!1}n||e.push(r)}g.metrics=e},S=function(e,a){g.metrics=[],t.getMetrics(e,u).then(function(t){t.length?(g.fullMetrics=t,g.isMetricEditMode?(E(t),a||g.getCascadedMetricDetails()):(E(t),0!==g.metrics.length&&(X(),g.isAddingNewTarget=!0,g.canAddMetricTarget=!1,g.action="Save",F())),0===g.metrics.length?(r.close(),r.notify(h.assignMetrics,{autoClose:!1,type:"danger"})):(g.renderingPageUrl="ngViews/targets/partials/add-primary-metric.min.html",g.isMetricExists=!0,g.canYearChange=!1)):(r.close(),r.notify(h.assignMetrics,{autoClose:!1,type:"danger"}))},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},P=function(t){var e=$.grep(g.metrics,function(e){return e.id==t});e.length&&(g.selectedMetricDataType=e[0].dataType)},k=function(){r.close();var t;if(g.metricData&&(t=$.grep(g.metricData,function(t){return 0===t.metricType})),t&&1==t.length){var e=f(t[0].effectiveEndDate),a=f(t[0].effectiveStartDate),n=e.getFullYear(),i=e.getMonth(),d=a.getMonth();d<=g.currentMonth&&i<=10&&(!g.isMetricEditMode||g.currentlyEditingTarget.id!=t[0].id)?(g.effectiveStartDate=new Date(n,i+1,1),g.effectiveStartDate>=g.effectiveEndDate&&(g.effectiveEndDate=f(g.years[g.years.length-2].endDate))):d!==g.currentMonth||11!==i||g.isMetricEditMode&&g.currentlyEditingTarget.id==t[0].id||(r.close(),r.notify(h.InvalidSecondPrimaryMetric,{autoClose:!1,type:"danger"}))}},C=function(){g.dateOptions.minDate=f(f(g.ParentMetricData.effectiveStartDate)>f(g.dateOptions.minDate)?g.ParentMetricData.effectiveStartDate:g.dateOptions.minDate),g.dateOptions.maxDate=f(f(g.ParentMetricData.effectiveEndDate)<f(g.dateOptions.maxDate)?g.ParentMetricData.effectiveEndDate:g.dateOptions.maxDate),g.isStretchGoalEnabled=g.ParentMetricData.isStretchGoalEnabled,g.trackingMethodId=g.ParentMetricData.trackingMethodId||0===g.ParentMetricData.trackingMethodId?g.ParentMetricData.trackingMethodId:0,g.graphPlottingMethodId=g.ParentMetricData.graphPlottingMethodId||0===g.ParentMetricData.graphPlottingMethodId?g.ParentMetricData.graphPlottingMethodId:0,g.onGraphPlottingMethodChanged(g.graphPlottingMethodId),g.mtdTrackingMethodId=g.ParentMetricData.mtdPerformanceTrackingMethodId||0===g.ParentMetricData.mtdPerformanceTrackingMethodId?g.ParentMetricData.mtdPerformanceTrackingMethodId:g.mtdTrackingMethodOptionsFiltered[0].id,angular.forEach(g.monthlyTargets,function(t,e){g.monthlyTargets[e].maximumAllowedGoal=g.ParentMetricData.maximumAllowedMonthlyGoals[e].value}),""===g.rollupMethodId&&(g.rollupMethodId=0)},b=function(){g.isCascadeFromParent?C():(g.dateOptions.minDate=f(g.isNextCalenderYearSelected?g.nextYearMinDate:g.currentYearMinDate),g.dateOptions.maxDate=f(g.isNextCalenderYearSelected?g.nextMaxDate:g.currentMaxDate),g.effectiveStartDate=f(g.effectiveStartDate?g.effectiveStartDate:g.currentlyEditingTarget.effectiveStartDate),g.effectiveEndDate=f(g.effectiveEndDate?g.effectiveEndDate:g.currentlyEditingTarget.effectiveEndDate),g.isStretchGoalEnabled=g.currentlyEditingTarget.isStretchGoalEnabled,g.trackingMethodId=g.currentlyEditingTarget.trackingMethodId||0===g.currentlyEditingTarget.trackingMethodId?g.currentlyEditingTarget.trackingMethodId:0,g.targetEntryMethodId=g.currentlyEditingTarget.targetEntryMethodId||0===g.currentlyEditingTarget.targetEntryMethodId?g.currentlyEditingTarget.targetEntryMethodId:1,g.graphPlottingMethodId=g.currentlyEditingTarget.graphPlottingMethodId||0===g.currentlyEditingTarget.graphPlottingMethodId?g.currentlyEditingTarget.graphPlottingMethodId:0,g.onGraphPlottingMethodChanged(g.graphPlottingMethodId),g.mtdTrackingMethodId=g.currentlyEditingTarget.mtdPerformanceTrackingMethodId||0===g.currentlyEditingTarget.graphPlottingMethodId?g.currentlyEditingTarget.mtdPerformanceTrackingMethodId:g.mtdTrackingMethodOptionsFiltered[0].id)},x=function(t){var e=g.currentDate.getMonth(),a=g.effectiveStartDate.getMonth();return!(g.isMetricEditMode&&e>a&&0==t&&1==g.trackingMethodId)||(r.notify(h.InvalidTargetEntry,{autoClose:!1,type:"danger"}),!1)},Y=function(e){var a;a=g.ParentMetricData.parentTargetId?g.ParentMetricData.parentTargetId:g.parentTargetId,t.getMaximumAllowedMonthlyGoals(a,g.rollupMethodId,g.targetId,e).then(function(t){t.hasError||angular.forEach(g.monthlyTargets,function(e,a){var r=$.grep(t,function(t){return t.month.id===e.month.id});r&&r.length>0&&(e.maximumAllowedGoal=r[0].value)})},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},O=function(){t.getRolledUpTargets(g.targetId,g.targetEntryMethodId,g.mtdTrackingMethodId).then(function(t){t.hasError||angular.forEach(g.monthlyTargets,function(e,a){var r=$.grep(t,function(t){return t.month.id===e.month.id});r&&r.length>0&&(e.rolledupGoalValue=r[0].value)})},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};g.getCascadedMetricDetails=function(e){P(g.metricId),m(g.selectedMetricDataType.id,e);var a={scorecardId:u,kpiId:g.tab,metricId:g.metricId,calendarYearId:g.yearId,metricType:g.metricType,targetId:g.targetId,targetEntryMethodId:g.targetEntryMethodId,rollUpMethodId:g.rollupMethodId,effectiveStartDate:d("date")(g.effectiveStartDate,"dd MMM yyyy"),effectiveEndDate:d("date")(g.effectiveEndDate,"dd MMM yyyy")};t.getCascadedMetricDetails(a).then(function(t){t?(g.isCascadeEnabled=!0,g.isCascadedFromParent=t.cascadeFromParent,g.ParentMetricData=t,g.isMetricEditMode&&b()):(g.isCascadeEnabled=!1,g.isCascadeFromParent=!1)},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},g.changeCascading=function(t){g.isMetricEditMode?g.getCascadedMetricDetails():g.isCascadeFromParent?(C(),g.ParentMetricData&&(g.targetEntryMethodId=g.ParentMetricData.targetEntryMethodId,g.onTargetEntryMethodChanged(g.targetEntryMethodId))):(g.dateOptions.minDate=f(g.isNextCalenderYearSelected?g.nextYearMinDate:g.currentYearMinDate),g.dateOptions.maxDate=f(g.isNextCalenderYearSelected?g.nextMaxDate:g.currentMaxDate),g.isStretchGoalEnabled="",g.trackingMethodId=0,g.graphPlottingMethodId=0,g.targetEntryMethodId=1,angular.forEach(g.monthlyTargets,function(t,e){g.monthlyTargets[e].maximumAllowedGoal=""})),g.resetMetricsList()},g.onGraphPlottingMethodChanged=function(t){g.mtdTrackingMethodOptionsFiltered=[],0===t?g.mtdTrackingMethodOptionsFiltered=$.grep(g.mtdTrackingMethodOptions,function(t){return 0!==t.id}):1===t&&(g.mtdTrackingMethodOptionsFiltered=$.grep(g.mtdTrackingMethodOptions,function(t){return 0===t.id})),g.mtdTrackingMethodOptionsFiltered.length>0&&(g.mtdTrackingMethodId=g.mtdTrackingMethodOptionsFiltered[0].id)},g.onTargetEntryMethodChanged=function(t,e){g.trackingMethodOptionsFiltered=[];var a=x(t);if(a){0===t?(g.trackingMethodOptionsFiltered=$.grep(g.trackingMethodOptions,function(t){return 1!=t.id}),g.trackingMethodId=0):1===t&&(g.trackingMethodOptionsFiltered=g.trackingMethodOptions,g.trackingMethodId=g.trackingMethodId?g.trackingMethodId:g.trackingMethodOptionsFiltered[0].id);var r=g.currentDate.getMonth()+1;g.monthlyTargets&&g.monthlyTargets.forEach(function(t){g.isMetricEditMode?t.month.id>r?(t.dailyRateValue=null,t.goalValue=null,t.stretchGoalValue=null,t.dailyTargets=[],t.hasManualTarget=!1,t.isManualTarget=!0):(t.dailyRateValue||0==t.dailyRateValue||t.goalValue||0==t.goalValue)&&(g.hasMonthlyAndDailyTargets=!0,t.month.id!=r&&t.month.id!=r-1||(t.hasManualTarget=!0,t.dailyTargets&&t.dailyTargets.forEach(function(t){t.isManual=!0}))):(t.dailyRateValue=null,t.stretchGoalValue=null,t.hasManualTarget=!1,t.goalValue=null,t.dailyTargets=[])}),g.isCascadeFromParent&&Y(t),g.isCascaded&&O()}else g.targetEntryMethodId=e,g.trackingMethodOptionsFiltered=g.trackingMethodOptions},g.onMTDPerformanceTrackingChanged=function(t){g.isCascaded&&O()},g.onRollupMethodChanged=function(e){var a;a=g.ParentMetricData.parentTargetId?g.ParentMetricData.parentTargetId:g.parentTargetId,t.getMaximumAllowedMonthlyGoals(a,e,g.targetId,g.targetEntryMethodId).then(function(t){if(!t.hasError&&g.monthlyTargets){var a=g.effectiveStartDate.getMonth();g.hasMonthlyAndDailyTargets&&(a=g.currentDate.getMonth()+1),g.monthlyTargets.forEach(function(r){if(r.month.id>a&&r.month.id<=g.effectiveEndDate.getMonth()+1){var n=$.grep(t,function(t){return t.month.id==r.month.id})[0];n&&(3==e&&(0==g.targetEntryMethodId?r.dailyRateValue=n.value:1==g.targetEntryMethodId&&(r.goalValue=n.value)),r.maximumAllowedGoal=n.value)}})}},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};var V=function(t){g.kpiTargetData=[],g.targets=[],g.monthlyData=[];for(var e=0;e<t.length;e++)g.monthlyData.push({month:t[e],goalValue:"",stretchGoalValue:"",maximumAllowedGoal:"",dailyRateValue:"",dailyTargets:[]});g.monthlyTargets=g.monthlyData},F=function(){t.getMonthsList(g.yearId).then(function(t){g.monthsList=t,V(g.monthsList)},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},N=function(t){var e=g.tab;S(e,t)};g.addNewTarget=function(){N(),g.onGraphPlottingMethodChanged(g.graphPlottingMethodId),g.isAddingNewTarget=!0},g.copyMetrics=function(){t.getSelectedYearTargets(u,g.yearId).then(function(t){t&&w(t)},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};var G=function(){g.copyFromYear="",g.copyToYear="",g.years[0].id==g.yearId?(g.copyFromYear=g.years[0],g.copyToYear=g.years[1]):g.years[1].id==g.yearId&&(g.copyFromYear=g.years[1],g.copyToYear=g.years[2])},w=function(t){G();var e=c.open({animation:!0,templateUrl:"ngViews/targets/templates/CopyTargetPopup.tpl.min.html",controller:"copyTargetController",controllerAs:"ctrl",windowClass:"copy-target-popup",backdrop:"static",keyboard:!1,resolve:{kpiTargets:function(){return t},targetParams:function(){var t={scorecardId:u,kpiId:g.tab,kpiName:W(g.tab),fromYear:g.copyFromYear,toYear:g.copyToYear};return t}}});return e.result.then(function(t){g.bindYearId(t.calendarYearId)},function(t){}),e},A=function(t){0===t?g.isPrimary=!0:g.isPrimary=!1},R=function(t){t.cascadeFromParent?(g.isCascadeFromParent=!0,g.isCascadeEnabled=!0):(g.isCascadeFromParent=!1,g.isCascadeEnabled=!1)};g.editTarget=function(t){g.currentlyEditingTarget=t,g.isMetricEditMode=!0,N(t.cascadeFromParent),g.action="Update",g.targetId=t.id,g.parentTargetId=t.parentTargetId,g.metricId=t.metricId,g.metricIdOnEdit=t.metricId,g.metricType=t.metricType,g.metricDataTypeId=t.metricDataTypeId,A(g.metricType),g.trackingMethodId=t.trackingMethodId,g.targetEntryMethodId=t.targetEntryMethodId,g.graphPlottingMethodId=t.graphPlottingMethodId,g.hasMonthlyAndDailyTargets=t.hasMonthlyAndDailyTargets;var e;null!==t.rollupMethodId&&(e=d("filter")(g.rollupMethodOptions,{id:t.rollupMethodId})[0]),e&&(g.rollupMethodId=e.id),g.onGraphPlottingMethodChanged(g.graphPlottingMethodId,t.mtdPerformanceTrackingMethodId),g.onTargetEntryMethodChanged(g.targetEntryMethodId),g.mtdTrackingMethodId=t.mtdPerformanceTrackingMethodId,g.cascadedMetricsTrackingMethodId=t.cascadedMetricsTrackingMethodId,g.isCascaded=t.isCascaded,g.annualTarget=t.annualTarget,g.monthlyTargets=t.monthlyTargets,g.isStretchGoalEnabled=t.isStretchGoalEnabled,R(t),g.effectiveStartDate=f(t.effectiveStartDate),g.effectiveEndDate=f(t.effectiveEndDate),g.canAddMetricTarget=!0,g.selectedMetricDataType.id=g.metricDataTypeId,m(g.selectedMetricDataType.id)},g.deleteTarget=function(a){var n=e.openConfirmationModal("md",h.DeleteConfirmationMsg);n.result.then(function(){t.deleteMetricTarget(a.id,a.scorecardId).then(function(t){t&&r.notify(a.metricName+" "+h.DeletedSuccessfully,{type:"success"}).then(function(){g.setTab(g.tab)})},function(t){r.notify(t.errors.join("<br/>"),{type:"danger"}).then(function(){g.setTab(g.tab)})})},function(){})};var U=function(t){if(null==t.effectiveStartDate||""==t.effectiveStartDate)g.errors.push(h.RequiredEffectiveStartDate);else{var e=f(t.effectiveStartDate);f(g.currentDate)!=e&&t.effectiveStartDate<g.currentDate&&g.errors.push(h.PastEffectiveStartDate)}},j=function(t){null==g.effectiveEndDate||""==g.effectiveEndDate?g.errors.push(h.RequiredEffectiveEndDate):t.effectiveEndDate<g.currentDate&&g.errors.push(h.PastEffectiveEndDate)},L=function(t){null!=t.effectiveStartDate&&""!=t.effectiveStartDate&&null!=t.effectiveEndDate&&""!=t.effectiveEndDate&&f(t.effectiveStartDate)>=f(t.effectiveEndDate)&&g.errors.push(h.InvalidDateRange)},q=function(){g.goalEntered=!1,g.monthlyTargets.forEach(function(t){g.goalEntered||(1===g.targetEntryMethodId?null!==t.goalValue&&""!==t.goalValue?g.goalEntered=!0:g.goalEntered=!1:0===g.targetEntryMethodId&&(null!==t.dailyRateValue&&""!==t.dailyRateValue?g.goalEntered=!0:g.goalEntered=!1)),0===g.selectedMetricDataType.id&&(0===g.targetEntryMethodId&&null!==t.dailyRateValue&&""!==t.dailyRateValue?t.dailyRateValue=Math.floor(t.dailyRateValue):1===g.targetEntryMethodId&&null!==t.goalValue&&""!==t.goalValue&&(t.goalValue=Math.floor(t.goalValue)))}),g.goalEntered||g.errors.push(1===g.targetEntryMethodId?h.RequiredMonthlyTarget:h.RequiredDailyRate);var t=0,e=0,a=0;angular.forEach(g.monthlyTargets,function(r,n){null!=r.stretchGoalValue&&""!=r.stretchGoalValue&&0==g.selectedMetricDataType.id&&(r.stretchGoalValue=Math.floor(r.stretchGoalValue)),angular.isUndefined(r.goalValue)&&0===t&&(g.errors.push(h.InvalidGoal),t+=1),angular.isUndefined(r.stretchGoalValue)&&0===e&&(g.errors.push(h.InvalidStretchGoal),e+=1),angular.isUndefined(g.annualTarget)&&0===a&&(g.errors.push(h.InvalidAnnualTarget),a+=1)})},K=function(t){g.errors=[],""===t.metricType&&g.errors.push(h.RequiredMetricType),""===t.metricId&&g.errors.push(h.RequiredMetricName),null!=t.effectiveStartDate&&""!=t.effectiveStartDate||null!=t.effectiveEndDate&&""!=t.effectiveEndDate?(U(t),j(t),L(t)):g.errors.push(h.RequiredEffectiveStartDateAndEffectiveEndDate),q()},B=function(t,e){"view"===e||null!==g.metricId&&""!==g.metricId||g.errors.push(h.RequiredMetricName),1!==t.targetEntryMethod||null!==t.goalValue&&""!==t.goalValue||null!==t.dailyRateValue&&""!==t.dailyRateValue||g.errors.push(h.SetMonthlyTarget)},W=function(t){switch(t){case 0:return"Safety";case 1:return"Quality";case 2:return"Delivery";case 3:return"Innovation";case 4:return"Cost";case 5:return"People [Culture]";case 6:return"Revenue";case 7:return"Net Working Capital"}},z=function(t){var e=$.grep(g.metrics,function(e){if(e.id===t)return e});return e.length?e[0].name:(g.targetData.metricId="","")},Q=function(t){var e=$.grep(g.years,function(e){if(e.name==t)return e});return e[0].id},H=function(){g.canAddMetricTarget=!0,g.addOrUpdateTargetForm.$setPristine(),g.kpiName=W(g.targetData.kpiId),g.metricName=z(g.targetData.metricId),g.targetData.metricDataTypeId=g.selectedMetricDataType.id,t.setTarget(g.targetData).then(function(t){r.notify(g.metricName+" for "+g.kpiName+" "+h.SetSuccessfully,{type:"success"}).then(function(){g.setTab(g.tab,g.targetData.id,g.targetData.metricType),g.isSaving=!1})},function(t){g.isSaving=!1,r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},J=function(){g.canAddMetricTarget=!0,g.addOrUpdateTargetForm.$setPristine(),g.targetData.id=g.targetId,g.kpiName=W(g.targetData.kpiId),g.metricName=z(g.targetData.metricId),g.targetData.metricDataTypeId=g.selectedMetricDataType.id,t.updateTarget(g.targetData).then(function(t){r.notify(g.metricName+" for "+g.kpiName+" "+h.UpdateSuccessfully,{type:"success"}).then(function(){g.setTab(g.tab,g.targetData.id),g.isSaving=!1})},function(t){g.isSaving=!1,r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};g.confirmSubmit=function(t){if(M(),K(g.targetData),g.errors.length)r.notify(g.errors.join("<br/>"),{autoClose:!1,type:"danger"});else{var a=e.openConfirmationModal("md",h.SubmitConfirmationMsg);a.result.then(function(){"Save"==g.action?(g.isSaving=!0,H()):"Update"==g.action&&(g.isSaving=!0,J())},function(){})}},g.submitDailyTarget=function(t,e,a,n){if(g.errors=[],B(t,e),!g.errors.length){var i=a?t.goalValue||0===t.goalValue?1:t.dailyRateValue||0===t.dailyRateValue?0:g.targetEntryMethodId:g.targetEntryMethodId;g.targetMonthid=t.month.id,g.monthlyTargetId=t.id?t.id:"";var o=c.open({animation:!0,templateUrl:"ngViews/targets/templates/dailyTargetPopup.tpl.min.html",controller:"dailyTargetController",controllerUrl:"ngControllers/target/daily-targets-tpl-controller.min",controllerAs:"ctrl",backdrop:"static",keyboard:!1,resolve:{monthTarget:function(){return t},targetParams:function(){var e={scorecardId:u,metricId:g.metricId,effectiveStartDate:d("date")(g.effectiveStartDate,"dd MMM yyyy"),effectiveEndDate:d("date")(g.effectiveEndDate,"dd MMM yyyy"),metricDataTypeId:n,targetEntryMethod:i,kpiId:g.tab,monthId:t.month.id,yearId:g.yearId,showDailyAndMonthly:a};return e},monthlyTargetId:t.id,mode:function(){return e}}});return o.result.then(function(t){var e=t;i!=g.targetEntryMethodId&&e.dailyTargets.forEach(function(t){t.isManual=!0});var a=$.grep(g.monthlyTargets,function(t){return t.month.id===g.targetMonthid})[0];a.goalValue=e.goalValue,a.dailyRateValue=e.dailyRateValue,a.dailyTargets=e.dailyTargets,a.hasManualTarget=$.grep(e.dailyTargets,function(t){return t.isManual===!0}).length>0},function(t){}),o}r.notify(g.errors.join("<br/>"),{type:"danger",autoClose:!1})};var X=function(){g.canYearChange=!0,g.isCascadeEnabled=!1,g.isCascadeFromParent=!1,g.isCascaded=!1,g.isSaving=!1,g.isMetricEditMode=!1,g.canAddMetricTarget=!0,g.isStretchGoalEnabled=!1,g.hasMonthlyAndDailyTargets=!1,g.isAddingNewTarget=!1,g.targetId="",g.metricId="",g.metricType="",g.annualTarget="",g.monthlyTargets="",g.rollupMethodId="",g.cascadedMetricsTrackingMethodId="",g.effectiveStartDate=f(g.isNextCalenderYearSelected?g.years[g.years.length-1].startDate:g.currentMonthStartDate),g.effectiveEndDate=f(g.isNextCalenderYearSelected?g.years[g.years.length-1].endDate:g.years[g.years.length-2].endDate),g.ParentMetricData={},g.selectedMetricDataType={},g.trackingMethodId=0,g.targetEntryMethodId=1,g.graphPlottingMethodId=0,g.dateOptions.minDate=f(g.isNextCalenderYearSelected?g.nextYearMinDate:g.currentYearMinDate),g.dateOptions.maxDate=f(g.isNextCalenderYearSelected?g.nextMaxDate:g.currentMaxDate),m(g.selectedMetricDataType.id),g.onTargetEntryMethodChanged(g.targetEntryMethodId)};g.cancel=function(){g.addOrUpdateTargetForm.$setPristine(),X(),g.metricData?(g.isMetricExists=!0,g.renderingPageUrl="ngViews/targets/partials/view-target.min.html",g.setTab(g.tab)):g.isMetricExists=!1};var Z=function(e,a){t.getKpis(e,a).then(function(t){g.existingKPIs=t,g.tab||(g.tab=g.existingKPIs[0].id),g.setTab(g.tab)},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};g.resetMonthlyStretchGoals=function(){angular.forEach(g.monthlyTargets,function(t,e){g.monthlyTargets[e].stretchGoalValue=""})},g.metricTypeChange=function(t){void 0!==t&&0===t&&(g.isPrimary=!0,"Update"!=g.action&&(g.isStretchGoalEnabled=!1,g.trackingMethodId=g.trackingMethodOptionsFiltered[0].id,g.graphPlottingMethodId=0,g.targetEntryMethodId=1),k()),void 0!==t&&1==t&&(g.isPrimary=!1,"Update"!=g.action&&(g.isStretchGoalEnabled=!1,g.trackingMethodId=g.trackingMethodOptionsFiltered[0].id,g.targetEntryMethodId=1),g.isMetricEditMode?g.effectiveStartDate=f(g.currentlyEditingTarget.effectiveStartDate):g.effectiveStartDate=f(g.isNextCalenderYearSelected?g.nextYearMinDate:g.currentMonthStartDate)),g.metricId&&g.getCascadedMetricDetails(),g.resetMetricsList()};var _=function(){t.getTargetsInitialData(u,!g.isViewTarget).then(function(t){t.hasError||(g.currentDate=f(t.currentDate),g.currentMonthStartDate=t.currentMonthStartDate,g.years=t.years,tt(),g.currentMaxDate=f(t.years[g.years.length-2].endDate),g.nextYearMinDate=f(t.years[g.years.length-1].startDate),g.nextMaxDate=f(t.years[g.years.length-1].endDate),g.dateOptions={minDate:g.currentYearMinDate,maxDate:g.currentMaxDate},g.rollupMethodOptions=t.rollupMethods,g.metricTypeOptions=t.metricTypes,g.isBowlingChartApplicable=t.isBowlingChartApplicable,g.trackingMethodOptions=t.trackingMethods,g.trackingMethodOptionsFiltered=g.trackingMethodOptions,g.targetEntryMethodOptions=t.targetEntryMethods,g.graphPlottingMethodOptions=t.graphPlottingMethods,g.mtdTrackingMethodOptions=t.mtdTrackingMethods,g.cascadedMetricsTrackingMethods=t.cascadedMetricsTrackingMethods,g.yearId=Q(g.currentYear),o.title="NDMS Scorecard : "+t.scorecardName,o.kpiOwners=t.kpiOwners,g.scorecardName=t.scorecardName,m(),Z(u,g.yearId))},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},tt=function(){g.currentYear=g.currentDate.getFullYear(),g.currentMonth=g.currentDate.getMonth(),g.effectiveEndDate=f(g.years[g.years.length-2].endDate),g.currentYearMinDate=f(g.currentMonthStartDate),g.effectiveStartDate=f(g.currentMonthStartDate)};(function(){_()})()}])});