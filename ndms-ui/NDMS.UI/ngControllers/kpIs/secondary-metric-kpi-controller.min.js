"use strict";define(["angularAMD","kpiLetter","kpiService","actualsService","configService"],function(a){a.controller("secondaryMetricKpiController",["$scope","kpiService","actualsService","configService","notificationService","$uibModal","$uibModalInstance","metricDetails",function(a,t,e,i,d,o,r,l){var n=this;n.metricDetails=l,n.isShowingGoal=!0,n.day=l.day,n.kpiId=l.kpiId,n.yearId=l.yearId,n.kpiname=l.kpiname,n.monthId=l.monthId,n.currentMonthId=l.currentMonthId,n.currentYearId=l.currentYearId,n.targetId=l.targetId,n.metricDetails.metricType="secondary",n.scorecardId=l.scorecardId,n.displayMonth=l.displayMonth,n.initialMonthArrayIndex=l.initialMonthArrayIndex,n.monthList=l.monthList,n.isAuthorizedUser=l.isAuthorizedUser,n.isClickOnMetricDisabled=!1,n.isUserAuthorizedToAlterScorecardEntries=l.isUserAuthorizedToAlterScorecardEntries,n.isViewMode=l.isViewMode,n.isRefreshGraph=!1,n.targetEntryMethodId=l.targetEntryMethodId,n.dailyRate=l.dailyRate,n.graphPlottingMethodId=l.graphPlottingMethodId,n.mtdGoal=l.mtdGoal,n.changedValues={},n.metricActualsIndicationData={},n.actualModalData={id:"",goalValue:"",stretchGoalValue:"",metricName:"",date:"",currentActual:"",status:"",day:"",targetId:"",month:"",year:"",metricDataTypeId:"",kpiId:n.kpiId,scorecardId:n.scorecardId,metricId:"",isMonthlyTracking:"",isPrimary:"",targetEntryMethodId:"",dailyRate:"",graphPlottingMethodId:"",mtdGoal:""};var c=i.getUIResources("Actuals"),s=function(a){o.open({animation:n.animationsEnabled,templateUrl:"ngViews/actuals/partials/primary-metric.min.html",controller:"ActualsController",controllerAs:"ctrl",windowClass:"actual-popup",backdrop:"static",keyboard:!1,size:"md",resolve:{modalData:function(){return n.actualModalData}}}).result.then(function(){g(),n.isClickOnMetricDisabled=!1},function(){n.isClickOnMetricDisabled=!1})},u=function(a,t){n.holidayModalData=n.actualModalData;o.open({animation:n.animationsEnabled,templateUrl:"ngViews/actuals/partials/mark-holiday.min.html",controller:"ActualsController",controllerAs:"ctrl",windowClass:"actual-popup",backdrop:"static",keyboard:!1,size:"md",resolve:{modalData:function(){return n.holidayModalData.status=a.status,n.holidayModalData.targetId=l.targetId,n.holidayModalData.scorecardId=n.scorecardId,n.actualModalData.isPrimary=!1,n.actualModalData.isMonthlyTracking=n.isMonthlyTracking,n.isMonthlyTracking||(n.actualModalData.day=a.day),n.holidayModalData.date=new Date(n.displayMonth.details.year,n.displayMonth.details.id-1,a.day),n.actualModalData.targetEntryMethodId=n.targetEntryMethodId,n.actualModalData.dailyRate=n.dailyRate,n.actualModalData.graphPlottingMethodId=n.graphPlottingMethodId,n.actualModalData.mtdGoal=n.mtdGoal,n.holidayModalData}}}).result.then(function(){n.isRefreshGraph=!0,g(),n.isClickOnMetricDisabled=!1},function(){n.isClickOnMetricDisabled=!1})},h=function(a,e,i,o){t.getDetailedSecondaryMetricData(a,e,i,o).then(function(a){n.metricActualsIndicationData=a,n.metricActualsIndicationData.kpiId=n.kpiId,n.metricActualsIndicationData.monthlyActuals?(n.metricDetails.month=n.metricActualsIndicationData.monthlyActuals[0].month,n.isMonthlyTracking=!0):(n.metricDetails.month=i,n.isMonthlyTracking=!1),n.metricDetails.targetEntryMethodId=a.targetEntryMethodId,n.metricDetails.dailyRate=a.dailyRate,n.metricDetails.graphPlottingMethodId=a.graphPlottingMethodId,n.metricDetails.mtdGoal=a.mtdGoal},function(a){d.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},M=function(a,t){if(4!=a.status){var e=m(a,t);e?I(a,t):n.isClickOnMetricDisabled=!1}else n.isClickOnMetricDisabled=!1},y=function(a,t){if(4!=a.status){var e=n.monthList.indexOf(n.displayMonth.details),i=e>=n.initialMonthArrayIndex||e==n.initialMonthArrayIndex-1;i=i,i?u(a,t):n.isClickOnMetricDisabled=!1}else n.isClickOnMetricDisabled=!1},m=function(a,t){var e;if(3!=a.status&&(e=!0),a.day&&t.month)a.day>n.day&&t.month==n.currentMonthId&&(e=!1);else if(a.month){var i=n.currentYearId-1,d=1===n.currentMonthId?12:n.currentMonthId-1;e=a.month==n.monthId||a.month==d&&(12!=d||i==n.yearId)}return e=!(!e||n.isViewMode)},I=function(a,t){t.isCascaded?(n.isClickOnMetricDisabled=!1,d.notify(c.CannotEnterActualForcCscaded,{autoClose:!1,type:"danger"})):(n.actualModalData.metricName=t.metricName,n.actualModalData.currentActual=a.value,n.actualModalData.status=a.status,n.actualModalData.targetId=t.targetId,n.actualModalData.id=a.id,n.actualModalData.day=a.day,n.actualModalData.metricDataTypeId=t.metricDataTypeId,n.actualModalData.isPrimary=!1,n.actualModalData.metricId=t.metricId,n.actualModalData.kpiId=t.kpiId,n.actualModalData.scorecardId=n.scorecardId,n.actualModalData.month=t.month,n.isMonthlyTracking?(n.actualModalData.goalValue=t.goalValue,n.actualModalData.isMonthlyTracking=n.isMonthlyTracking,n.actualModalData.month=a.month,n.actualModalData.date=new Date(n.displayMonth.details.year,a.month-1,n.day)):n.actualModalData.date=new Date(n.displayMonth.details.year,n.displayMonth.details.id-1,a.day),D(t,a)),n.actualModalData.targetEntryMethodId=t.targetEntryMethodId,n.actualModalData.dailyRate=t.dailyRate,n.actualModalData.graphPlottingMethodId=t.graphPlottingMethodId,n.actualModalData.mtdGoal=t.mtdGoal},D=function(a,t){var i=n.isMonthlyTracking?t.month:a.month;e.getTargets(a.targetId,i,t.day).then(function(a){n.actualModalData.goalValue=a,s()},function(a){n.isClickOnMetricDisabled=!1,d.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},g=function(){h(n.kpiId,n.yearId,n.monthId,n.targetId)};n.cancel=function(){d.close(),n.changedValues.targetId=n.targetId,n.changedValues.isRefreshGraph=n.isRefreshGraph,r.close(n.changedValues)},n.showSecondaryMetricActualPopup=function(a,t,e){if(n.isAuthorizedUser&&n.isUserAuthorizedToAlterScorecardEntries){if(n.isClickOnMetricDisabled)return;switch(n.isClickOnMetricDisabled=!0,n.actualModalData={},t){case"secondary":M(a,e);break;case"holiday":y(a,e)}}else n.isAuthorizedUser&&d.notify(c.NotAuthorizedToChange,{autoClose:!0,type:"danger"})};(function(){h(n.kpiId,n.yearId,n.monthId,n.targetId)})()}])});