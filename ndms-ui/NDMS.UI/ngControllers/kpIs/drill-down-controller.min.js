"use strict";define(["angularAMD","actualsService","d3js","hierarchyChartDirective","hierarchyChartHelper"],function(e){e.controller("drillDownController",["actualsService","validationService","notificationService","configService","hierarchyChartDirective","$rootScope","$routeParams","$filter","monthNavigationService","configurationService","$scope","$location","$q","utilityService",function(e,t,r,n,a,o,i,d,c,s,l,I,h,u){var D=this,y=i.scorecardId;D.kpiId=i.kpiId,D.monthId=parseInt(i.monthId),D.yearId=parseInt(i.yearId),D.scorecardKPIs=[],D.selectedDate="",D.isDataLoaded=!1,D.dateOptions={},D.showTree=!1,D.previousKPI=i.kpiId,D.previousMonthId=parseInt(i.monthId),D.previousYearId=parseInt(i.yearId),o.title="Drill-Down",o.kpiOwners=[],o.scorecardId="";var p=function(){var e=h.defer();return s.getCurrentDateAndYearId().then(function(t){var r=t.currentDate.slice(0,10);D.currentMonthId=parseInt(d("date")(r,"M"),10),D.currentYearId=t.yearId,D.currentDay=d("date")(r,"dd"),D.currentYear=parseInt(d("date")(r,"yyyy")),e.resolve()},function(t){e.reject(t)}),e.promise},f=function(){e.getScorecardKPIs(y,D.monthId,D.yearId).then(function(e){D.scorecardKPIs=e,D.scorecardKPIs.length>0?(D.isKPIExists(D.kpiId)||(D.kpiId=D.scorecardKPIs[0].id),D.setTab(parseInt(D.kpiId))):(D.drillDownData=[],D.showTree=!1,D.isDataLoaded=!0)},function(e){r.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},v=function(){s.getAllYearMonthsList().then(function(e){c.setMonthDetails(e,D.monthId,D.yearId),o.displayMonth=c.getSelectedMonthDetails(),D.year=o.displayMonth.year,P(D.year,D.monthId)},function(e){r.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},M=function(){D.isDataLoaded=!1,D.drillDownData=[],e.getDrillDownHierarchy(y,D.kpiId,D.monthId,D.yearId).then(function(e){D.drillDownData=e,D.isDataLoaded=!0,D.showTree=D.scorecardKPIs.length>0&&null!=D.drillDownData})},w=function(){D.drillDownData=[],D.isDataLoaded=!1;var t=g(D.selectedDate);t=d("date")(t,"dd MMM yyyy"),e.getDrillDownHierarchyOnDate(y,D.kpiId,t).then(function(e){D.drillDownData=e,D.isDataLoaded=!0,D.showTree=D.scorecardKPIs.length>0&&null!=D.drillDownData})},g=function(e){return u.convertToDateWithoutTimezone(e)},m=function(){var e=c.getMonthList();c.setMonthDetails(e,D.monthId,D.yearId),o.displayMonth=c.getSelectedMonthDetails(),D.year=o.displayMonth.year,P(D.year,D.monthId)},P=function(e,t){var r=new Date(e,t,0).getDate(),n=new Date(e,t-1,1),a=new Date(e,t-1,r),o=r;e===D.currentYear&&t===D.currentMonthId&&(o=D.currentDay);var i=new Date(e,t-1,o);D.dateOptions={minDate:n,maxDate:a,initDate:i,showWeeks:!1,maxMode:"day"}};l.$on("monthChange",function(){D.monthId=o.displayMonth.id,D.yearId=o.displayMonth.yearId,D.year=o.displayMonth.year,D.selectedDate="",f(),P(D.year,D.monthId)}),l.$watch("ctrl.selectedDate",function(e,t){e!==t&&""!==e&&D.scorecardKPIs.length>0&&w()}),D.resetDrillDown=function(){D.selectedDate="",D.monthId=D.currentMonthId,D.yearId=D.currentYearId,m(),f()},D.navigateToKPI=function(){I.url("KPI/"+D.previousKPI+"/"+y+"/"+D.previousYearId+"/"+D.previousMonthId+"/"+D.currentDay).replace(),l.$$phase||l.$apply()},D.setTab=function(e){D.kpiId=e,M()},D.isKPIExists=function(e){var t;return D.scorecardKPIs&&(t=d("filter")(D.scorecardKPIs,{id:e})[0]),!(!t||void 0===t.id)},D.isSet=function(e){return D.kpiId===e};(function(){p().then(function(){v(),f()})})()}])});