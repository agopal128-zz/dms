"use strict";define(["angularAMD","kpiLetter","counterMeasure","kpiService","actualsController","counterMeasureController","secondaryMetricKpiController","actualsService","configurationService","highchart","graphDirective","validNumber","metricType","notificationModalService"],function(a){a.controller("kpiController",["$routeParams","kpiService","actualsService","$uibModal","notificationService","$location","$scope","$filter","$q","configurationService","sessionStorageService","$rootScope","authService","configService","$timeout","notificationModalService","monthNavigationService",function(a,t,e,r,i,o,n,d,c,s,l,u,h,p,y,M,m){var I=this;I.isShowingGoal=!0,I.kpiId=parseInt(a.kpiId),I.scorecardId=parseInt(a.scorecardId),I.yearId=parseInt(a.yearId),I.monthId=parseInt(a.monthId),I.day=parseInt(a.day),I.isViewMode=!1,I.prevMonthId=I.monthId-1,I.isGraphDataLoaded=!1,I.graphPlottingPage="kpi",u.scorecardId=I.scorecardId,u.disableHeader=!0,u.navigateToScorecard=function(){angular.isUndefined(u.scorecardYearId)&&(u.scorecardYearId=I.yearId),angular.isUndefined(u.scorecardMonthId)&&(u.scorecardMonthId=I.monthId),u.scorecardId&&(o.url("Scorecard/"+u.scorecardId+"/"+u.scorecardYearId+"/"+u.scorecardMonthId).replace(),n.$$phase||n.$apply())};var D=l.get("scorecardName");D&&(u.title="NDMS Scorecard : "+l.get("scorecardName")),I.goalText="",I.stretchGoalText="",I.animationsEnabled=!0,I.actualModalData={id:"",goalValue:"",stretchGoalValue:"",metricName:"",date:"",currentActual:"",status:"",day:"",targetId:"",month:"",year:"",metricDataTypeId:"",kpiId:I.kpiId,scorecardId:I.scorecardId,metricId:"",isMonthlyTracking:"",isPrimary:"",mtdGoal:""},I.primaryMetricDetails={},I.kpiIndicationData={},I.fiscalMonthData={},I.monthList={},I.currentDate="",I.displayMonth={id:"",details:""},I.primaryStretchGoalValue="",I.primaryGoalValue=null;var g=p.getUIResources("Actuals"),f=p.getUIResources("Scorecard");I.graphData={},I.metricDetails=[],I.actualData={scorecardId:"",kpiId:"",metricId:""},I.scorecardMetricTargetId=0,I.scorecardKpiMetrics=[];var k=function(a){switch(a){case 0:return"Safety";case 1:return"Quality";case 2:return"Delivery";case 3:return"Innovation";case 4:return"Cost";case 5:return"People [Culture]";case 6:return"Revenue";case 7:return"Net Working Capital"}};I.kpiname=k(I.kpiId);var A=function(){t.getAllCounterMeasureStatus().then(function(a){if(a.data){I.statusLegends=a.data;for(var t=0;t<I.statusLegends.length;t++){var e=I.statusLegends[t].id;C(t,e)}}},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},C=function(a,t){switch(t){case 0:I.statusLegends[a].counterMeasureStatus="status statusnoprogress";break;case 1:I.statusLegends[a].counterMeasureStatus="status statusinvestigation";break;case 2:I.statusLegends[a].counterMeasureStatus="status statusidentified";break;case 3:I.statusLegends[a].counterMeasureStatus="status statusimplemented";break;case 4:I.statusLegends[a].counterMeasureStatus="status statusconfirmed"}},v=function(a,e,r){t.getCounterMeasures(a,e,r).then(function(a){I.counterMeasureData=a,I.counterMeasureData.length>0&&A()},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},S=function(a){U(I.scorecardId,I.kpiId,I.yearId,I.monthId,!1),E(I.scorecardId,I.kpiId,I.yearId),v(I.scorecardId,I.kpiId,!1),a.targetId==I.scorecardMetricTargetId?I.loadGraphForMetric():a.isRefreshGraph&&I.loadGraphForMetric(),0===I.kpiId&&z(I.scorecardId,I.yearId,I.monthId),n.$$phase||n.$apply()},b=function(a){r.open({animation:I.animationsEnabled,templateUrl:"ngViews/actuals/partials/primary-metric.min.html",controller:"ActualsController",controllerAs:"ctrl",windowClass:"actual-popup",backdrop:"static",keyboard:!1,size:"md",resolve:{modalData:function(){return I.actualModalData}}}).result.then(function(a){a.isRefreshGraph=!1,S(a),I.isClickOnMetricDisabled=!1},function(){I.isClickOnMetricDisabled=!1})},G=function(a,t){I.holidayModalData=I.actualModalData;r.open({animation:I.animationsEnabled,templateUrl:"ngViews/actuals/partials/mark-holiday.min.html",controller:"ActualsController",controllerAs:"ctrl",windowClass:"actual-popup",backdrop:"static",keyboard:!1,size:"md",resolve:{modalData:function(){return I.holidayModalData.status=a.status,I.holidayModalData.targetId=t.targetId,I.holidayModalData.scorecardId=I.scorecardId,I.actualModalData.isPrimary=!0,I.actualModalData.isMonthlyTracking=I.isMonthlyTracking,I.actualModalData.dailyRate=t.dailyRate,I.isMonthlyTracking||(I.actualModalData.day=a.day),I.holidayModalData.date=new Date(I.displayMonth.details.year,I.displayMonth.details.id-1,a.day),I.actualModalData.targetEntryMethodId=t.targetEntryMethodId,I.actualModalData.graphPlottingMethodId=t.graphPlottingMethodId,I.holidayModalData}}}).result.then(function(a){a.isRefreshGraph=!0,S(a),I.isClickOnMetricDisabled=!1},function(){I.isClickOnMetricDisabled=!1})},T=function(){r.open({animation:I.animationsEnabled,templateUrl:"ngViews/counter-measure/partials/counter-measure-popup.min.html",controller:"counterMeasureController",controllerAs:"ctrl",windowClass:"counter-measure-popup",backdrop:"static",keyboard:!1,resolve:{metricDetails:function(){return I.metricDetails},actualData:function(){return I.actualData},counterMeasure:function(){}}}).result.then(function(){v(I.scorecardId,I.kpiId,!1)})},w=function(a,t){var r=I.isMonthlyTracking?t.month:a.month;e.getTargets(a.targetId,r,t.day).then(function(a){I.actualModalData.goalValue=a,b()},function(a){I.isClickOnMetricDisabled=!1,i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},x=function(a,t){t.isCascaded?(I.isClickOnMetricDisabled=!1,i.notify(g.CannotEnterActualForcCscaded,{autoClose:!1,type:"danger"})):(I.actualModalData.metricName=t.metricName,I.actualModalData.currentActual=a.value,I.actualModalData.status=a.status,I.actualModalData.targetId=t.targetId,I.actualModalData.id=a.id,I.actualModalData.day=a.day,I.actualModalData.metricDataTypeId=t.metricDataTypeId,I.actualModalData.isPrimary=!0,I.actualModalData.metricId=t.metricId,I.actualModalData.kpiId=I.kpiId,I.actualModalData.scorecardId=I.scorecardId,I.actualModalData.month=t.month,I.actualModalData.dailyRate=t.dailyRate,I.isMonthlyTracking?(I.actualModalData.goalValue=t.monthlyGoalValue,I.actualModalData.isMonthlyTracking=I.isMonthlyTracking,I.actualModalData.month=a.month,I.actualModalData.date=new Date(I.displayMonth.details.year,a.month-1,I.day)):I.actualModalData.date=new Date(I.displayMonth.details.year,I.displayMonth.details.id-1,a.day),I.actualModalData.mtdGoal=t.monthlyGoalValue,w(t,a))},V=function(a,t){var e;if(3!=a.status&&(e=!0),a.day&&t.month)a.day>I.day&&t.month==I.currentMonthId&&(e=!1);else if(a.month){var r=I.currentYearId-1,i=1===I.currentMonthId?12:I.currentMonthId-1;e=a.month==I.monthId||a.month==i&&(12!=i||r==I.yearId)}return e=!(!e||I.isViewMode)},O=function(a,t){if(4!=a.status){var e=V(a,t);e=e,e?x(a,t):I.isClickOnMetricDisabled=!1}else I.isClickOnMetricDisabled=!1},L=function(a,t){if(4!=a.status){var e=I.monthList.indexOf(I.displayMonth.details),r=e>=I.initialMonthArrayIndex||e==I.initialMonthArrayIndex-1;r=r,r?G(a,t):I.isClickOnMetricDisabled=!1}else I.isClickOnMetricDisabled=!1};I.showActualsOrHolidayPopup=function(a,t,e){if(I.isAuthorizedUser&&I.isUserAuthorizedToAlterScorecardEntries){if(I.isClickOnMetricDisabled)return;switch(I.isClickOnMetricDisabled=!0,I.actualModalData={},t){case"primary":O(a,e);break;case"holiday":L(a,e)}}else I.isAuthorizedUser&&i.notify(g.NotAuthorizedToChange,{autoClose:!0,type:"danger"})},I.openSecondaryMetricDetailedPopup=function(a){r.open({animation:I.animationsEnabled,templateUrl:"ngViews/kpIs/partials/secondary-metric-kpi.min.html",controller:"secondaryMetricKpiController",controllerAs:"ctrl",windowClass:"secondary-metric-popup",backdrop:"static",keyboard:!1,resolve:{metricDetails:function(){return a.scorecardId=I.scorecardId,a.kpiId=I.kpiId,a.kpiname=I.kpiname,a.day=I.day,a.monthId=I.monthId,a.yearId=I.yearId,a.monthList=I.monthList,a.displayMonth=I.displayMonth,a.currentMonthId=I.currentMonthId,a.currentYearId=I.currentYearId,a.initialMonthArrayIndex=I.initialMonthArrayIndex,a.isAuthorizedUser=I.isAuthorizedUser,a.isUserAuthorizedToAlterScorecardEntries=I.isUserAuthorizedToAlterScorecardEntries,a.isViewMode=I.isViewMode,a}}}).result.then(function(a){S(a),I.isClickOnMetricDisabled=!1},function(){I.isClickOnMetricDisabled=!1})},I.proceedToAddCounterMeasure=function(){I.actualData={scorecardId:I.scorecardId,kpiId:I.kpiId,metricId:""},T()};var N=function(a,t){a&&a.primaryMetricData?(I.primaryMetricDetails.metricName=a.primaryMetricData.metricName,I.primaryMetricDetails.targetId=a.primaryMetricData.targetId,I.primaryMetricDetails.metricDataTypeId=a.primaryMetricData.metricDataTypeId,I.primaryMetricDetails.metricId=a.primaryMetricData.metricId,I.primaryMetricDetails.isCascaded=a.primaryMetricData.isCascaded,I.primaryMetricDetails.monthlyGoalValue=a.primaryMetricData.monthlyGoalValue,I.primaryMetricDetails.metricType="primary",I.primaryGoalValue=a.primaryMetricData.monthlyGoalValue,I.primaryStretchGoalValue=a.primaryMetricData.monthlyStretchGoalValue,I.primaryMetricDetails.dailyRate=a.primaryMetricData.dailyRate,I.primaryMetricDetails.targetEntryMethodId=a.primaryMetricData.targetEntryMethodId,I.primaryMetricDetails.graphPlottingMethodId=a.primaryMetricData.graphPlottingMethodId,a.primaryMetricData.monthlyActuals?(I.primaryMetricDetails.month=a.primaryMetricData.monthlyActuals[0].month,I.isMonthlyTracking=!0):(I.primaryMetricDetails.month=t,I.isMonthlyTracking=!1)):(I.primaryStretchGoalValue=I.primaryGoalValue=null,I.primaryMetricDetails.metricName="")},P=function(a){if(I.scorecardKpiMetrics=[],I.scorecardMetricTargetId=0,a||(I.isGraphDataLoaded=!0,I.isGraphData=!1),a){a.primaryMetricData&&(I.scorecardKpiMetrics.push({id:a.primaryMetricData.targetId,name:a.primaryMetricData.metricName}),I.scorecardMetricTargetId=a.primaryMetricData.targetId);var t=[];a.secondaryMetricsData&&(t=d("orderBy")(a.secondaryMetricsData,"metricName")),angular.forEach(t,function(a){I.scorecardKpiMetrics.push({id:a.targetId,name:a.metricName})}),0==I.scorecardMetricTargetId&&I.scorecardKpiMetrics.length>0&&(I.scorecardMetricTargetId=I.scorecardKpiMetrics[0].id),0!=I.scorecardMetricTargetId?I.loadGraphForMetric():(I.isGraphDataLoaded=!0,I.isGraphData=!1)}},U=function(a,e,r,o,n){t.getScorecardKPIData(a,e,r,o).then(function(a){I.kpiIndicationData=a,u.disableHeader=!1,N(a,o),n&&P(a)},function(a){u.disableHeader=!1,i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},z=function(a,e,r){t.getBasicScorecardData(a,e,r).then(function(t){I.kpiOwners=JSON.stringify(t.kpiOwners),l.set("scorecardName",t.scorecardName),l.set("scorecardId",a),u.kpiOwners=JSON.parse(I.kpiOwners),u.daysWithoutRecordables=t.daysWithoutRecordables,u.title="NDMS Scorecard : "+t.scorecardName,t.isPatternAssigned||y(function(){i.notify(f.PatternNotSetError.format(I.displayMonth.details.name,I.displayMonth.details.year),{autoClose:!1,type:"danger"})},1e3)},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},E=function(a,e,r){t.getFiscalMonthStatusForKPI(a,e,r).then(function(a){I.fiscalMonthData=a},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},R=function(){s.getAllYearMonthsList().then(function(a){I.monthList=a,m.setMonthDetails(a,I.monthId,I.yearId),u.displayMonth=m.getSelectedMonthDetails(),I.displayMonth.details=m.getSelectedMonthDetails(),I.currentMonthDetails=$.grep(I.monthList,function(a){return a.yearId===I.currentYearId&&a.id==I.currentMonthId})[0],I.initialMonthArrayIndex=I.monthList.indexOf(I.currentMonthDetails),I.monthArrayIndex=I.monthList.indexOf(I.displayMonth.details),I.initialMonthArrayLength=I.monthArrayLength=I.monthList.length-1,I.selectedYearId=I.displayMonth.details.yearId,Y()},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},K=function(a,e,r,o){I.isAuthorizedUser&&t.getScorecardKPIMetrics(a,e,r,o).then(function(a){I.metricDetails=a},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},Y=function(){var a=I.monthList.indexOf(I.displayMonth.details);a==I.initialMonthArrayIndex?I.isViewMode=!1:a==I.initialMonthArrayIndex-1?I.isViewMode=!1:I.isViewMode=!0},j=function(a){var t,e=I.graphData;a.dailyGraphData?(t=a.dailyGraphData,e.xAxis.trackingMethode="daily"):a.monthlyGraphData&&(t=a.monthlyGraphData,e.xAxis.trackingMethode="monthly"),e.xAxis.max=t.length-1,e.series.push({data:[]}),e.series.push({data:[]}),angular.forEach(t,function(a,t){e.series[0].data.push(a.actualValue),e.series[2].data.push(a.goalValue),e.series[1].data.push(a.stretchGoalValue),e.xAxis.categories.push(t+1)}),e.yAxis.min=a.minValue,e.yAxis.max=a.maxValue,I.graphData=e,I.isGraphDataLoaded=!0};I.loadGraphForMetric=function(){I.graphData={},t.getScorecardMetricKPIGraphData(I.scorecardMetricTargetId,I.kpiId,I.yearId,I.monthId).then(function(a){I.isGraphDataLoaded=!0,a&&(a.dailyGraphData||a.monthlyGraphData)?(I.graphData={series:[{data:[]}],yAxis:{min:"",max:"",tickInterval:""},xAxis:{min:"",max:"",tickInterval:"",categories:[],trackingMethode:""}},I.isGraphData=!0,j(a)):I.isGraphData=!1},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},n.$on("monthChange",function(){I.selectedYearId=u.displayMonth.yearId,I.displayMonth.details=u.displayMonth,Y(),I.monthId=I.displayMonth.details.id,I.yearId=I.displayMonth.details.yearId,U(I.scorecardId,I.kpiId,I.displayMonth.details.yearId,I.displayMonth.details.id,!0),E(I.scorecardId,I.kpiId,I.displayMonth.details.yearId),v(I.scorecardId,I.kpiId,!1),K(I.scorecardId,I.kpiId,I.yearId,I.monthId)}),I.reloadCounterMeasureTable=function(){v(I.scorecardId,I.kpiId,I.counterMeasureIncludeClosed)};var F=function(a,t){return t.indexOf(a)>-1},H=function(){if(I.isAuthorized=h.isAuthorized(),I.isAuthorized){J(I.scorecardId);var a=JSON.parse(l.get("userData"));if(a){var t=F("Admin",a.roles),e=F("KPIOwner",a.roles),r=F("TeamMember",a.roles);I.isAuthorizedUser=I.isAuthorized&&(t||e||r)}}},J=function(){I.isUserAuthorizedToAlterScorecardEntries=!1,e.isUserAuthorizedToAlterScorecardEntries(I.scorecardId).then(function(a){I.isUserAuthorizedToAlterScorecardEntries=a},function(a){i.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};I.drillDown=function(){o.path("Drilldown/"+I.scorecardId+"/"+I.kpiId+"/"+I.monthId+"/"+I.yearId),n.$$phase||n.$apply()};var W=function(){var a=c.defer();return s.getCurrentDateAndYearId().then(function(t){var e=t.currentDate.slice(0,10);I.currentMonthId=parseInt(d("date")(e,"M"),10),I.currentYearId=t.yearId,I.currentDay=d("date")(e,"dd"),a.resolve()},function(t){a.reject(t)}),a.promise};(function(){W().then(function(){z(I.scorecardId,I.yearId,I.monthId),U(I.scorecardId,I.kpiId,I.yearId,I.monthId,!0),E(I.scorecardId,I.kpiId,I.yearId),R(),v(I.scorecardId,I.kpiId,!1),H(),K(I.scorecardId,I.kpiId,I.yearId,I.monthId)})})()}])});