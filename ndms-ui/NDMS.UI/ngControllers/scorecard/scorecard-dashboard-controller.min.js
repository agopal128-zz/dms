"use strict";define(["angularAMD","kpiLetter","kpiService","highchart","graphDirective","dashboardHelper","utilityService"],function(a){a.controller("scorecardDashboardController",["$routeParams","kpiService","authService","notificationService","$location","configService","$scope","sessionStorageService","$rootScope","configurationService","$filter","$q","utilityService","monthNavigationService","$timeout",function(a,e,r,t,o,n,c,s,d,i,h,u,l,p,I){var y=this,f=s.get("scorecardId");y.scorecardId=parseInt(a.id)?parseInt(a.id):f;var g=n.getUIResources("Scorecard");!f&&y.scorecardId&&s.set("scorecardId",y.scorecardId),y.scorecardData={scorecardId:"",scorecardName:"",kpiOwners:""},y.kpiOwners=[],y.graphPlottingPage="scorecard",y.isGraphDataLoaded={},y.isGraphData={},d.disableHeader=!0;var D=function(a,r,o){y.isGraphDataLoaded={},y.isGraphData={},e.getScorecardData(a,r,o).then(function(a){y.kpiDashboardData=a,y.scorecardData={scorecardId:parseInt(a.scorecardId),scorecardName:a.scorecardName,kpiOwners:a.kpiOwners,daysWithoutRecordables:a.daysWithoutRecordables},v(y.scorecardId,r),k(y.scorecardId,r,o),a.isPatternAssigned||I(function(){t.notify(g.PatternNotSetError.format(d.displayMonth.name,d.displayMonth.year),{autoClose:!1,type:"danger"})},1e3)},function(a){t.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},m=function(a,r,o){e.getScorecardData(a,r,o).then(function(a){y.kpiDashboardData=a,y.scorecardData={scorecardId:parseInt(a.scorecardId),scorecardName:a.scorecardName,kpiOwners:a.kpiOwners,daysWithoutRecordables:a.daysWithoutRecordables},d.title="NDMS Scorecard : "+a.scorecardName,d.kpiOwners=y.scorecardData.kpiOwners,d.daysWithoutRecordables=y.scorecardData.daysWithoutRecordables,d.disableHeader=!1,s.set("scorecardName",y.scorecardData.scorecardName),v(y.scorecardId,y.yearId),k(y.scorecardId,y.yearId,y.monthId),a.isPatternAssigned||I(function(){t.notify(g.PatternNotSetError.format(d.displayMonth.name,d.displayMonth.year),{autoClose:!1,type:"danger"})},1e3)},function(a){d.disableHeader=!1,t.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},v=function(a,r){e.getFiscalMonthStatusForScorecard(a,r).then(function(a){y.fiscalMonthData=a},function(a){t.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};y.navigateToKpi=function(a){var e=p.getSelectedMonthDetails();e.yearId==y.yearId&&e.month==y.monthId?(d.scorecardYearId=parseInt(y.yearId),d.scorecardMonthId=parseInt(y.monthId),o.url("KPI/"+a+"/"+y.scorecardData.scorecardId+"/"+y.yearId+"/"+y.monthId+"/"+y.day).replace()):(d.scorecardYearId=parseInt(e.yearId),d.scorecardMonthId=parseInt(e.id),o.url("KPI/"+a+"/"+y.scorecardData.scorecardId+"/"+e.yearId+"/"+e.id+"/"+y.day).replace()),c.$$phase||c.$apply()},y.showBackButton=function(){return!(d.referrer.endsWith("/NDMSUI/Login/")||!r.isAuthorized())},c.$on("monthChange",function(){var a=p.getSelectedMonthDetails();D(y.scorecardId,a.yearId,a.id)});var S=function(a,e){var r,t={series:[{data:[]}],yAxis:{min:"",max:"",tickInterval:""},xAxis:{min:"",max:"",tickInterval:"",categories:[],trackingMethode:""}};a.dailyGraphData?(r=a.dailyGraphData,t.xAxis.max=r.length-1,t.xAxis.trackingMethode="daily"):a.monthlyGraphData&&(r=a.monthlyGraphData,t.xAxis.max=r.length-1,t.xAxis.trackingMethode="monthly"),t.series.push({data:[]}),t.series.push({data:[]}),angular.forEach(r,function(a,e){t.series[0].data.push(a.actualValue),t.series[1].data.push(a.stretchGoalValue),t.series[2].data.push(a.goalValue),t.xAxis.categories.push(e+1)}),t.yAxis.min=a.minValue,t.yAxis.max=a.maxValue,y.graphData[e]=t,y.isGraphDataLoaded[e]=!0},k=function(a,r,o){y.graphData=[],e.getScorecardGraphData(a,r,o).then(function(a){var e=a;angular.forEach(e.data,function(a,e){y.isGraphDataLoaded[e]=!0,a&&(a.dailyGraphData||a.monthlyGraphData)?(y.isGraphData[e]=!0,S(a,e)):y.isGraphData[e]=!1})},function(a){t.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},x=function(){var e=u.defer();return i.getCurrentDateAndYearId().then(function(r){var t=r.currentDate.slice(0,10);y.monthId=parseInt(a.monthId)?parseInt(a.monthId):parseInt(h("date")(t,"M"),10),y.yearId=isNaN(parseInt(a.yearId))?r.yearId:parseInt(a.yearId),y.day=h("date")(t,"dd"),e.resolve()},function(a){e.reject(a)}),e.promise},M=function(){i.getAllYearMonthsList().then(function(a){p.setMonthDetails(a,y.monthId,y.yearId),d.displayMonth=p.getSelectedMonthDetails()},function(a){t.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},b=function(){isNaN(y.scorecardId)!==!0&&(M(),m(y.scorecardId,y.yearId,y.monthId)),y.isBackButtonVisible=y.showBackButton()};(function(){x().then(function(){b()})})()}])});