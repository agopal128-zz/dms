"use strict";define(["angularAMD","scorecardService","organizationalDataService","titleCase","validNumber","utilityService","workdayPattern"],function(e){e.controller("ScorecardAdminController",["scorecardService","organizationalDataService","validationService","notificationService","configService","$http","$routeParams","$location","$scope","$q","$rootScope","sessionStorageService","utilityService","$filter",function(e,t,a,r,i,n,s,d,o,c,l,u,p,f){var v=this,m=i.getUIResources("Scorecard"),y=s.id,S=s.mode,k=JSON.parse(u.get("configData"));v.maxKPIOwnerCount=k?k.maxKPIOwnerCount:4,v.maxTeamCount=k?k.maxTeamCount:15,v.scorecardId=parseInt(y),v.mode=s.mode,l.scorecardId="","Edit"===v.mode?(v.parentId="false"!==s.parentId?s.parentId:"",v.hasParent=""!==v.parentId,v.displayMode=!1):"Add"===v.mode&&(v.parentId=0===v.scorecardId?null:v.scorecardId,v.hasParent=0!==v.scorecardId,v.displayMode=!0),v.tags=[],v.kpiOwners=[],v.teams=[],v.selected_KPIs=[],v.dateOptions={},v.recordable={},v.isSaving=!1,v.selectedIds=[],v.selectedBusinessSegmentIds=[],v.selectedBusinessSegments=[],v.selectedDivisionIds=[],v.selectedDivisions=[],v.selectedFacilityIds=[],v.selectedFacilities=[],v.selectedProductLineIds=[],v.selectedProductLines=[],v.selectedDepartmentIds=[],v.selectedDepartments=[],v.selectedProcessIds=[],v.selectedProcesses=[],v.seletedListCount=1e3;var g=function(e){return p.convertToDateWithoutTimezone(e)};v.loadTags=function(t){var a=c.defer();return e.loadADUsers(t).then(function(e){e?(v.seletedListCount=e?e.length:1e3,a.resolve(e)):a.reject()}),a.promise},v.scorecard={name:"",parentScorecardId:"",rootScorecardId:"",businessSegment:{},division:{},facility:{},productLine:{},department:{},process:{},kpiOwners:[],teams:[],isBowlingChartApplicable:!1,kpIs:[],drilldownLevel:2,isActive:!0,scorecardWorkdayPattern:{},scorecardHolidayPattern:{},isActiveWorkdayPattern:!1,isActiveHolidyPattern:!1,isNextWorkdayPatternAvailable:!1,isNextHolidayPattrenAvailable:!1,isEmptyWorkdayPatternAvailable:!1,nextWorkdayPatternName:"",nextHolidayPatternName:""},v.validationRules={Name:[new ValidationRule(validationType.required,(!0),m.RequiredScorecardName)],KPIOwner:[new ValidationRule(validationType.required,(!0),m.RequiredKPIOwner)],Team:[new ValidationRule(validationType.required,(!0),m.RequiredTeam)],IsBowlingChart:[new ValidationRule(validationType.required,(!0),m.RequiredIsBowlingChart)],KPISelection:[new ValidationRule(validationType.required,(!0),m.RequiredKPISelection)],DrilldownLevel:[new ValidationRule(validationType.required,(!0),m.RequiredDrilldownLevel),new ValidationRule(validationType.max,99,m.InvalidDrilldownLevel),new ValidationRule(validationType.valid,(!0),m.InvalidDrilldownLevel)]},v.setParentData=function(e){e.parentScorecardItem&&(v.scorecard.parentName=e.parentScorecardItem.name,v.parentName=v.scorecard.parentName,v.scorecard.parentScorecardId=e.parentScorecardItem.id)},v.setScorecardOptions=function(e){v.businessSegmentOptions=e.businessSegments,v.divisionOptions=e.divisions,v.facilityOptions=e.facilities,v.productLineOptions=e.productLines,v.departmentOptions=e.departments,v.processOptions=e.processes,v.KPIs=e.kpIs,v.HolidayPatterns=e.scorecardHolidayPatterns},v.removeOrganizationalDropdowns=function(){var e=$("#business-segments").data("kendoMultiSelect");void 0!=e&&(e.destroy(),$("#business-segments").unwrap(".k-multiselect").show().empty(),$(".k-multiselect-wrap").remove());var t=$("#divisions").data("kendoMultiSelect");void 0!=t&&(t.destroy(),$("#divisions").unwrap(".k-multiselect").show().empty(),$(".k-multiselect-wrap").remove());var a=$("#facilities").data("kendoMultiSelect");void 0!=a&&(a.destroy(),$("#facilities").unwrap(".k-multiselect").show().empty(),$(".k-multiselect-wrap").remove());var r=$("#productlines").data("kendoMultiSelect");void 0!=r&&(r.destroy(),$("#productlines").unwrap(".k-multiselect").show().empty(),$(".k-multiselect-wrap").remove());var i=$("#departments").data("kendoMultiSelect");void 0!=i&&(i.destroy(),$("#departments").unwrap(".k-multiselect").show().empty(),$(".k-multiselect-wrap").remove());var n=$("#processes").data("kendoMultiSelect");void 0!=n&&(n.destroy(),$("#processes").unwrap(".k-multiselect").show().empty(),$(".k-multiselect-wrap").remove())},v.CreateOrganizationalDropDowns=function(){$("#business-segments").kendoMultiSelect({autoClose:!1,dataSource:v.businessSegmentOptions,dataTextField:"name",dataValueField:"id",filter:"contains",itemTemplate:"<input type='checkbox'/>&nbsp;#:data.name# ",dataBound:function(){var e=this.ul.find("li");setTimeout(function(){D(e)})},change:function(){var e=this.ul.find("li");D(e)}}).data("kendoMultiSelect"),$("#divisions").kendoMultiSelect({autoClose:!1,dataSource:v.divisionOptions,dataTextField:"name",dataValueField:"id",filter:"contains",itemTemplate:"<input type='checkbox'/>&nbsp;#:data.name# ",dataBound:function(){var e=this.ul.find("li");setTimeout(function(){D(e)})},change:function(){var e=this.ul.find("li");D(e)}}).data("kendoMultiSelect"),$("#facilities").kendoMultiSelect({autoClose:!1,dataSource:v.facilityOptions,dataTextField:"name",dataValueField:"id",filter:"contains",itemTemplate:"<input type='checkbox'/>&nbsp;#:data.name# ",dataBound:function(){var e=this.ul.find("li");setTimeout(function(){D(e)})},change:function(){var e=this.ul.find("li");D(e)}}).data("kendoMultiSelect"),$("#productlines").kendoMultiSelect({autoClose:!1,dataSource:v.productLineOptions,dataTextField:"name",dataValueField:"id",filter:"contains",itemTemplate:"<input type='checkbox'/>&nbsp;#:data.name# ",dataBound:function(){var e=this.ul.find("li");setTimeout(function(){D(e)})},change:function(){var e=this.ul.find("li");D(e)}}).data("kendoMultiSelect"),$("#departments").kendoMultiSelect({autoClose:!1,dataSource:v.departmentOptions,dataTextField:"name",dataValueField:"id",filter:"contains",itemTemplate:"<input type='checkbox'/>&nbsp;#:data.name# ",dataBound:function(){var e=this.ul.find("li");setTimeout(function(){D(e)})},change:function(){var e=this.ul.find("li");D(e)}}).data("kendoMultiSelect"),$("#processes").kendoMultiSelect({autoClose:!1,dataSource:v.processOptions,dataTextField:"name",dataValueField:"id",filter:"contains",itemTemplate:"<input type='checkbox'/>&nbsp;#:data.name# ",dataBound:function(){var e=this.ul.find("li");setTimeout(function(){D(e)})},change:function(){var e=this.ul.find("li");D(e)}}).data("kendoMultiSelect")},v.setScorecardTemplateData=function(e){"Add"==S&&(v.removeOrganizationalDropdowns(),v.CreateOrganizationalDropDowns());var t=$("#business-segments").data("kendoMultiSelect"),a=$("#divisions").data("kendoMultiSelect"),r=$("#facilities").data("kendoMultiSelect"),i=$("#productlines").data("kendoMultiSelect"),n=$("#departments").data("kendoMultiSelect"),s=$("#processes").data("kendoMultiSelect");if(e.parentScorecardItem){if("Add"==S){var d=e.parentScorecardItem.businessSegments;null==d||angular.isUndefined(d)||(angular.forEach(d,function(e,t){v.selectedBusinessSegmentIds.push(e.id)}),t.value(v.selectedBusinessSegmentIds));var o=e.parentScorecardItem.divisions;null==o||angular.isUndefined(o)||(angular.forEach(o,function(e,t){v.selectedDivisionIds.push(e.id)}),a.value(v.selectedDivisionIds));var c=e.parentScorecardItem.facilities;null==c||angular.isUndefined(c)||(angular.forEach(c,function(e,t){v.selectedFacilityIds.push(e.id)}),r.value(v.selectedFacilityIds));var l=e.parentScorecardItem.productLines;null==l||angular.isUndefined(l)||(angular.forEach(l,function(e,t){v.selectedProductLineIds.push(e.id)}),i.value(v.selectedProductLineIds));var u=e.parentScorecardItem.departments;null==u||angular.isUndefined(u)||(angular.forEach(u,function(e,t){v.selectedDepartmentIds.push(e.id)}),n.value(v.selectedDepartmentIds));var p=e.parentScorecardItem.processes;null==p||angular.isUndefined(p)||(angular.forEach(p,function(e,t){v.selectedProcessIds.push(e.id)}),s.value(v.selectedProcessIds))}v.scorecard.drilldownLevel=e.parentScorecardItem.drilldownLevel}else"Add"==S&&(t.value(["0"]),a.value(["0"]),r.value(["0"]),i.value(["0"]),n.value(["0"]),s.value(["0"]));v.scorecard.rootScorecardId=e.rootScorecardId},v.setOrganizationDropdowns=function(e){var t=$("#business-segments").data("kendoMultiSelect"),a=t.ul.find("li");setTimeout(function(){D(a)});var r=$("#divisions").data("kendoMultiSelect"),i=r.ul.find("li");setTimeout(function(){D(i)});var n=$("#facilities").data("kendoMultiSelect"),s=n.ul.find("li");setTimeout(function(){D(s)});var d=$("#productlines").data("kendoMultiSelect"),o=d.ul.find("li");setTimeout(function(){D(o)});var c=$("#departments").data("kendoMultiSelect"),l=c.ul.find("li");setTimeout(function(){D(l)});var u=$("#processes").data("kendoMultiSelect"),p=u.ul.find("li");setTimeout(function(){D(p)});var f=e.businessSegments;null==f||angular.isUndefined(f)||(angular.forEach(f,function(e,t){v.selectedBusinessSegmentIds.push(e.id)}),t.value(v.selectedBusinessSegmentIds));var m=e.divisions;null==m||angular.isUndefined(m)||(angular.forEach(m,function(e,t){v.selectedDivisionIds.push(e.id)}),r.value(v.selectedDivisionIds));var y=e.facilities;null==y||angular.isUndefined(y)||(angular.forEach(y,function(e,t){v.selectedFacilityIds.push(e.id)}),n.value(v.selectedFacilityIds));var S=e.productLines;null==S||angular.isUndefined(S)||(angular.forEach(S,function(e,t){v.selectedProductLineIds.push(e.id)}),d.value(v.selectedProductLineIds));var k=e.departments;null==k||angular.isUndefined(k)||(angular.forEach(k,function(e,t){v.selectedDepartmentIds.push(e.id)}),c.value(v.selectedDepartmentIds));var g=e.processes;null==g||angular.isUndefined(g)||(angular.forEach(g,function(e,t){v.selectedProcessIds.push(e.id)}),u.value(v.selectedProcessIds))},v.setScorecard=function(){v.scorecard.parentScorecardId=0===v.scorecardId?null:y,v.scorecard.kpiOwners=v.kpiOwners,v.scorecard.teams=v.teams,v.scorecard.recordable={recordableDate:f("date")(v.recordable.recordableDate,"dd MMM yyyy")},v.scorecard.kpIs=$.grep(v.KPIs,function(e){return e.isSelected===!0});var e=$("#business-segments").data("kendoMultiSelect").dataItems();v.scorecard.businessSegments=e;var t=$("#divisions").data("kendoMultiSelect").dataItems();v.scorecard.divisions=t;var a=$("#facilities").data("kendoMultiSelect").dataItems();v.scorecard.facilities=a;var r=$("#productlines").data("kendoMultiSelect").dataItems();v.scorecard.productLines=r;var i=$("#departments").data("kendoMultiSelect").dataItems();v.scorecard.departments=i;var n=$("#processes").data("kendoMultiSelect").dataItems();v.scorecard.processes=n},v.save=function(){v.isSaving=!0,v.setScorecard(),r.close(),a.validate("add-scorecard").then(function(){e.addScorecard(v.scorecard).then(function(e){e.hasError||e.data&&r.notify(m.AddedSuccessfully,{type:"success"}).then(function(){v.isSaving=!1,b(),h(v.scorecard.rootScorecardId||e.data)})},function(e){v.isSaving=!1,r.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},function(e){v.isSaving=!1,r.notify(e.join("<br/>"),{autoClose:!1,type:"danger"})})},v.Update=function(){v.isSaving=!0,v.setScorecard(),0==v.scorecard.isNextWorkdayPatternAvailable&&(v.scorecard.scorecardWorkdayPattern=null),0==v.scorecard.isNextHolidayPattrenAvailable&&(v.scorecard.scorecardHolidayPattern=null),r.close(),a.validate("add-scorecard").then(function(){e.updateScorecard(v.scorecard).then(function(){r.notify(m.UpdatedSuccessfully,{type:"success"}).then(function(){v.isSaving=!1,b(),h(v.scorecard.rootScorecardId||v.scorecard.id)})},function(e){v.isSaving=!1,r.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},function(e){v.isSaving=!1,r.notify(e.join("<br/>"),{autoClose:!1,type:"danger"})})},v.cancel=function(){h(v.scorecard.rootScorecardId||v.scorecard.id)},v.getLookupData=function(){var e=c.defer();return t.getScorecardTemplateData(v.parentId).then(function(t){v.setScorecardOptions(t),v.setScorecardTemplateData(t),v.setParentData(t),e.resolve()},function(t){r.notify(t.errors.join("<br/>"),{autoClose:!1,type:"danger"}),e.reject(t.errors)}),e.promise},v.ChangeWorkdayPattern=function(){v.scorecard.isNextWorkdayPatternAvailable=!0},v.ChangeHolidayPattern=function(){v.scorecard.isNextHolidayPattrenAvailable=!0};var P=function(){e.getScorecard(y).then(function(e){I(e)},function(e){r.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},h=function(e){l.lastActiveTopLevelScorecardId=e?e:null,d.path("Hierarchy")},I=function(e){if(v.scorecard=e,v.kpiOwners=e.kpiOwners,v.teams=e.teams,v.businessSegments=e.businessSegments,v.divisions=e.divisions,v.facilities=e.facilities,v.productLines=e.productLines,v.departments=e.departments,v.processes=e.processes,v.recordable.recordableDate=null!=e.recordable&&null!=e.recordable.recordableDate?g(e.recordable.recordableDate):"",v.disableLastRecordableDate=null!=e.recordable&&null!=e.recordable.recordableDate&&!e.recordable.isManual,O(e.kpIs),v.scorecard.isActiveWorkdayPattern=!0,v.scorecard.isActiveHolidyPattern=!0,v.scorecard.scorecardWorkdayPattern=e.scorecardWorkdayPattern,v.scorecard.activeScorecardWorkdayPattern=e.activeScorecardWorkdayPattern,v.scorecard.scorecardHolidayPattern=e.scorecardHolidayPattern,v.scorecard.activeScorecardHolidayPattern=e.activeScorecardHolidayPattern,null!=v.scorecard.scorecardWorkdayPattern){null!=v.scorecard.activeScorecardWorkdayPattern&&v.scorecard.scorecardWorkdayPattern.effectiveStartDate!=v.scorecard.activeScorecardWorkdayPattern.effectiveStartDate?(v.scorecard.isNextWorkdayPatternAvailable=!0,v.scorecard.isEmptyWorkdayPatternAvailable=!1):(v.scorecard.isNextWorkdayPatternAvailable=!1,v.scorecard.isEmptyWorkdayPatternAvailable=!1);var t=g(e.nextWorkdayPatternStartDate),a=f("date")(t,"MMM"),r=f("date")(t,"dd"),i=f("date")(t,"yyyy");v.scorecard.nextWorkdayPatternName="Starting "+r+"-"+a+"-"+i}else{v.scorecard.scorecardWorkdayPattern={},v.scorecard.scorecardWorkdayPattern.isSunday=!1,v.scorecard.scorecardWorkdayPattern.isMonday=!1,v.scorecard.scorecardWorkdayPattern.isTuesday=!1,v.scorecard.scorecardWorkdayPattern.isWednesday=!1,v.scorecard.scorecardWorkdayPattern.isThursday=!1,v.scorecard.scorecardWorkdayPattern.isFriday=!1,v.scorecard.scorecardWorkdayPattern.isSaturday=!1,v.scorecard.isActiveWorkdayPattern=!1;var t=g(e.currentWorkdayPatternStartDate),a=f("date")(t,"MMM"),r=f("date")(t,"dd"),i=f("date")(t,"yyyy");v.scorecard.nextWorkdayPatternName="Starting "+r+"-"+a+"-"+i,null==v.scorecard.activeScorecardWorkdayPattern?(v.scorecard.isEmptyWorkdayPatternAvailable=!0,v.scorecard.isNextWorkdayPatternAvailable=!1):v.scorecard.isNextWorkdayPatternAvailable=!1}if(null!=v.scorecard.scorecardHolidayPattern){null!=v.scorecard.activeScorecardHolidayPattern&&v.scorecard.scorecardHolidayPattern.effectiveStartDate!=v.scorecard.activeScorecardHolidayPattern.effectiveStartDate?v.scorecard.isNextHolidayPattrenAvailable=!0:v.scorecard.isNextHolidayPattrenAvailable=!1;var t=g(e.nextHolidayPatternStartDate),a=f("date")(t,"MMM"),r=f("date")(t,"dd"),i=f("date")(t,"yyyy");v.scorecard.nextHolidayPatternName="Starting "+r+"-"+a+"-"+i}else null==v.scorecard.activeScorecardHolidayPattern?v.scorecard.isNextHolidayPattrenAvailable=!0:v.scorecard.isNextHolidayPattrenAvailable=!1;v.selectedBusinessSegments=f("filter")(e.businessSegments,{isActive:"false"}),angular.forEach(v.selectedBusinessSegments,function(e,t){v.businessSegmentOptions.push(e)}),v.businessSegmentOptions=f("orderBy")(v.businessSegmentOptions,"name");var n=f("filter")(v.businessSegmentOptions,{id:0})[0];v.businessSegmentOptions.splice(v.businessSegmentOptions.indexOf(n),1),v.businessSegmentOptions.splice(0,0,n),v.selectedDivisions=f("filter")(e.divisions,{isActive:"false"}),angular.forEach(v.selectedDivisions,function(e,t){v.divisionOptions.push(e)}),v.divisionOptions=f("orderBy")(v.divisionOptions,"name");var s=f("filter")(v.divisionOptions,{id:0})[0];v.divisionOptions.splice(v.divisionOptions.indexOf(s),1),v.divisionOptions.splice(0,0,s),v.selectedFacilities=f("filter")(e.facilities,{isActive:"false"}),angular.forEach(v.selectedFacilities,function(e,t){v.facilityOptions.push(e)}),v.facilityOptions=f("orderBy")(v.facilityOptions,"name");var d=f("filter")(v.facilityOptions,{id:0})[0];v.facilityOptions.splice(v.facilityOptions.indexOf(d),1),v.facilityOptions.splice(0,0,d),v.selectedProductLines=f("filter")(e.productLines,{isActive:"false"}),angular.forEach(v.selectedProductLines,function(e,t){v.productLineOptions.push(e)}),v.productLineOptions=f("orderBy")(v.productLineOptions,"name");var o=f("filter")(v.productLineOptions,{id:0})[0];v.productLineOptions.splice(v.productLineOptions.indexOf(o),1),v.productLineOptions.splice(0,0,o),v.selectedDepartments=f("filter")(e.departments,{isActive:"false"}),angular.forEach(v.selectedDepartments,function(e,t){v.departmentOptions.push(e)}),v.departmentOptions=f("orderBy")(v.departmentOptions,"name");var c=f("filter")(v.departmentOptions,{id:0})[0];v.departmentOptions.splice(v.departmentOptions.indexOf(c),1),v.departmentOptions.splice(0,0,c),v.selectedProcesses=f("filter")(e.processes,{isActive:"false"}),angular.forEach(v.selectedProcesses,function(e,t){v.processOptions.push(e)}),v.processOptions=f("orderBy")(v.processOptions,"name");var l=f("filter")(v.processOptions,{id:0})[0];v.processOptions.splice(v.processOptions.indexOf(l),1),v.processOptions.splice(0,0,l),v.removeOrganizationalDropdowns(),v.CreateOrganizationalDropDowns(),v.setOrganizationDropdowns(e)},b=function(){e.getHierarchyDropdownList().then(function(){},function(e){r.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},O=function(e){for(var t=e.map(function(e){return e.id}),a=0;a<v.KPIs.length;a++)$.inArray(v.KPIs[a].id,t)!==-1?v.KPIs[a].isSelected=!0:v.KPIs[a].isSelected=!1},D=(function(){v.CreateOrganizationalDropDowns(),v.getLookupData().then(function(){"Edit"===S?(P(),v.displayMode=!1,l.title="Edit Scorecard"):"Add"===S&&(v.displayMode=!0,v.disableLastRecordableDate=!1,v.scorecard.scorecardWorkdayPattern.isSunday=!1,v.scorecard.scorecardWorkdayPattern.isMonday=!0,v.scorecard.scorecardWorkdayPattern.isTuesday=!0,v.scorecard.scorecardWorkdayPattern.isWednesday=!0,v.scorecard.scorecardWorkdayPattern.isThursday=!0,v.scorecard.scorecardWorkdayPattern.isFriday=!0,v.scorecard.scorecardWorkdayPattern.isSaturday=!1,v.scorecard.isActiveWorkdayPattern=!1,v.scorecard.isActiveHolidyPattern=!1,v.scorecard.isNextWorkdayPatternAvailable=!0,v.scorecard.isNextHolidayPattrenAvailable=!0,v.scorecard.isEmptyWorkdayPatternAvailable=!1,v.scorecard.scorecardHolidayPattern.holidayPatternId=1,v.scorecard.nextWorkdayPatternName="Workday Pattern",v.scorecard.nextHolidayPatternName="Holiday Schedule",l.title="Add Scorecard")},function(e){r.notify(e.join("<br/>"),{autoClose:"false",type:"danger"})})}(),function(e){e.each(function(){var e=$(this),t=e.children("input");t.prop("checked",e.hasClass("k-state-selected"))})})}])});