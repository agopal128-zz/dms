"use strict";define(["angularAMD","scorecardService","utilityService"],function(e){e.controller("counterMeasureController",["$scope","configService","notificationService","validationService","scorecardService","$uibModalInstance","actualData","counterMeasure","$filter","utilityService","authService","$q","metricDetails",function(e,t,a,i,r,s,u,o,n,c,d,l,f){var m=this,y=t.getUIResources("Actuals");m.actualData={},m.actualData=u;var M=m.actualData.scorecardId,D={};m.status=0,m.dateOptions={},m.counterMeasureStatusId=o?o.counterMeasureStatusId:null,m.iseditableView=d.isAuthorized()&&m.actualData.isUserAuthorisedToEdit&&4!=m.counterMeasureStatusId,m.metricOptions=f,m.metricId,m.isCounterMeasureSaveDisabled=!1,m.counterMeasurePriority={};var v=function(e){return c.convertToDateWithoutTimezone(e)};m.seletedListCount=1e3,m.loadTags=function(e){var t=l.defer();return r.loadADUsers(e).then(function(e){e?(m.seletedListCount=e?e.length:1e3,t.resolve(e)):t.reject()}),t.promise};var g=function(){void 0!==m.actualData&&(m.actualData.isPrimary?m.actualData.date=n("date")(u.date,"fullDate"):m.actualData.date=n("date")(u.date,"MMMM, y")),void 0!==o?(m.iseditableView?(m.isEditFromTable=o.isEditFromTable,m.priorityName=o.counterMeasurePriorityName,m.actualData={},m.actualData.metricName=o.metricName,m.assignedTo=[{fullName:o.assignedUserName,accountName:o.assignedTo}]):(m.assignedTo=o.assignedUserName,m.actualData.metricName=o.metricName,m.priorityName=o.counterMeasurePriorityName),m.openedDate=o.openedDate,m.issue=o.issue,m.action=o.action,m.dueDate=v(o.dueDate),m.status=o.counterMeasureStatusId,m.priority=o.counterMeasurePriorityId,m.comment=o.comments):m.iseditableView=!0};m.saveCounterMeasure=function(){m.isEditFromTable?h():C()};var p=function(e){return D="add"==e?{scorecardId:m.actualData.scorecardId,kpiId:m.actualData.kpiId,metricId:m.actualData.metricId,issue:m.issue,action:m.action,dueDate:n("date")(m.dueDate,"dd MMM yyyy"),assignedTo:m.assignedTo[0].accountName,counterMeasureStatusId:m.status,counterMeasurePriorityId:m.priority,comment:m.newComment}:{scorecardId:M,counterMeasureId:o.id,action:m.action,dueDate:n("date")(m.dueDate,"dd MMM yyyy"),assignedTo:m.assignedTo[0].accountName,counterMeasureStatusId:m.status,counterMeasurePriorityId:m.priority,comment:m.newComment}},S=function(e){return m.assignedTo&&0!==m.assignedTo.length||e.push(y.RequiredWho),m.dueDate||e.push(y.RequiredDueDate),m.action&&0!==m.action.length||e.push(y.RequiredAction),m.issue&&0!==m.issue.length||e.push(y.RequiredIssue),e},C=function(){var e=[];e=S(e),a.close(),0===e.length?(D=p("add"),r.addCounterMeasure(D).then(function(e){a.notify(y.AddedSuccessfully,{type:"success",timeout:500}).then(function(){s.close(),m.isCounterMeasureSaveDisabled=!1})},function(e){a.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"}),m.isCounterMeasureSaveDisabled=!1})):(a.notify(e.join("<br/>"),{autoClose:!1,type:"danger"}),m.isCounterMeasureSaveDisabled=!1)},b=function(e){r.getCounterMeasureById(e).then(function(e){s.close(e.data),m.isCounterMeasureSaveDisabled=!1},function(e){a.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"}),m.isCounterMeasureSaveDisabled=!1})},h=function(){var e=[];e=S(e),a.close(),0===e.length?(D=p("update"),r.updateCounterMeasure(D).then(function(e){a.notify(y.UpdatedSuccessfully,{type:"success",timeout:500}).then(function(){o.isEditFromTable?b(D.counterMeasureId):(s.close(e.data),m.isCounterMeasureSaveDisabled=!1)})},function(e){a.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"}),m.isCounterMeasureSaveDisabled=!1})):(a.notify(e.join("<br/>"),{autoClose:!1,type:"danger"}),m.isCounterMeasureSaveDisabled=!1)},I=function(e){4==m.status?m.status=0:m.status+=1},T=function(){r.getCounterMeasurePriority().then(function(e){m.counterMeasurePriority=e},function(e){a.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})})};m.changeStatus=function(){var e=$("#status");I(e)},m.skipClick=function(){m.isSkip=!0,s.close(o),m.isCounterMeasureSaveDisabled=!1},m.cancel=function(){s.dismiss(o)};(function(){g(),T()})()}])});