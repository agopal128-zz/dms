"use strict";define(["angularAMD","metricsService","organizationalDataService","uiSelect","uiSelectWrap"],function(e){e.controller("AssignMetricsController",["metricsService","organizationalDataService","validationService","notificationService","configService","$scope","$q","$rootScope",function(e,i,t,n,d,a,o,r){var s=this,l=d.getUIResources("Metrics");s.assignMetricRow=[],s.assignedMetricData=[],s.businessSegment=[],s.division=[],s.facility=[],s.productline=[],s.department=[],s.process=[],s.kpi=[],s.metricLoaded=!1,s.metrics=[],s.activeMetrics=[],r.title="Assign Metrics",r.kpiOwners=[],r.scorecardId="",s.addNewRow=function(){s.gridOptions.data.unshift({id:"",businessSegment:{id:s.businessSegment[0].id,name:s.businessSegment[0].name},division:{id:s.division[0].id,name:s.division[0].name},facility:{id:s.facility[0].id,name:s.facility[0].name},productline:{id:s.productline[0].id,name:s.productline[0].name},department:{id:s.department[0].id,name:s.department[0].name},process:{id:s.process[0].id,name:s.process[0].name},kpi:"",metrics:"",isActive:!0})},s.refreshData=function(){s.gridOptions.data.length=0,s.metricLoaded=!1,c()},s.assignMetricColumnDefs=[{name:"id",displayName:"Id",field:"id",enableCellEdit:!1,visible:!1},{name:"businessSegment",displayName:"Business Segment",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.businessSegment.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",width:"14%",enableHiding:!1},{name:"division",displayName:"Division",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.division.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",width:"14%",enableHiding:!1},{name:"facility",displayName:"Facility",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.facility.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",width:"11%",enableHiding:!1},{name:"productline",displayName:"Product Line",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.productline.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",width:"12%",enableHiding:!1},{name:"department",displayName:"Department",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.department.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",enableHiding:!1,width:"11%"},{name:"process",displayName:"Process",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.process.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",enableHiding:!1,width:"10%"},{name:"kpi",displayName:"KPI",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.kpi.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",enableHiding:!1,width:"10%"},{name:"metrics",displayName:"Metric",type:"object",enableCellEdit:!0,cellFilter:"griddropdown:editDropdownOptionsArray:editDropdownIdLabel:editDropdownValueLabel:row.entity.metrics.name",editableCellTemplate:"ngViews/metrics/templates/uiSelect.html",editDropdownIdLabel:"id",editDropdownValueLabel:"name",enableHiding:!1,width:"18%"},{name:"isActive",displayName:"Status",type:"boolean",enableCellEdit:!1,visible:!1}],s.validationRules={Name:[new ValidationRule(validationType.required,(!0),l.RequiredMetricName)]};var p=function(e){for(var i=0;i<e.length;i++)s.assignedMetricData.push({id:e[i].id,isActive:e[i].isActive,businessSegment:{id:e[i].businessSegmentId,name:e[i].businessSegmentName},division:{id:e[i].divisionId,name:e[i].divisionName},facility:{id:e[i].facilityId,name:e[i].facilityName},productline:{id:e[i].productLineId,name:e[i].productLineName},department:{id:e[i].departmentId,name:e[i].departmentName},process:{id:e[i].processId,name:e[i].processName},kpi:{id:e[i].kpiId,name:e[i].kpiName},metrics:{id:e[i].metricId,name:e[i].metricName}});s.assignedMetricData.reverse()},c=function(){e.getAllAssignedMetricData().then(function(e){p(e),s.gridOptions.data=s.assignedMetricData,s.metricLoaded=!0},function(e){n.notify(e.errors[0].join("<br/>"),{type:"danger"})})},m=function(){s.gridOptions.columnDefs[1].editDropdownOptionsArray=s.businessSegment,s.gridOptions.columnDefs[2].editDropdownOptionsArray=s.division,s.gridOptions.columnDefs[3].editDropdownOptionsArray=s.facility,s.gridOptions.columnDefs[4].editDropdownOptionsArray=s.productline,s.gridOptions.columnDefs[5].editDropdownOptionsArray=s.department,s.gridOptions.columnDefs[6].editDropdownOptionsArray=s.process,s.gridOptions.columnDefs[7].editDropdownOptionsArray=s.kpi};s.getLookupData=function(){i.getMetricMappingTemplateData().then(function(e){s.businessSegment=e.businessSegments,s.division=e.divisions,s.facility=e.facilities,s.productline=e.productLines,s.department=e.departments,s.process=e.processes,s.kpi=e.kpIs,m()},function(e){n.notify(e.errors[0].join("<br/>"),{type:"danger"})}),e.getAllMetrics().then(function(e){s.metrics=e,angular.forEach(s.metrics,function(e){e.isActive===!0&&s.activeMetrics.push({id:e.id,name:e.name})}),s.gridOptions.columnDefs[8].editDropdownOptionsArray=s.activeMetrics},function(e){n.notify(e.errors[0].join("<br/>"),{type:"danger"})})},s.gridOptions={rowHeight:38,data:s.assignedMetricData,columnDefs:s.assignMetricColumnDefs,enableRowSelection:!1,enableRowHeaderSelection:!1,enableCellEditOnFocus:!1,enableSorting:!1,enableColumnMenus:!1},s.setMetricMappingData=function(e){s.assignMetricRow.push({id:e.id,businessSegmentId:e.businessSegment.id,divisionId:e.division.id,facilityId:e.facility.id,productLineId:e.productline.id,departmentId:e.department.id,processId:e.process.id,kpiId:e.kpi.id,metricId:e.metrics.id,isActive:e.isActive})};var u=function(e){s.addOperation=""===e};s.saveRow=function(i){s.metricLoaded=!1,s.setMetricMappingData(i);var t=o.defer();s.gridApi.rowEdit.setSavePromise(i,t.promise),u(s.assignMetricRow[0].id),e.addOrUpdateMetricMapping(s.assignMetricRow).then(function(e){t.resolve(),s.addOperation?n.notify(l.AddedSuccessfully,{type:"success"}).then(function(){s.gridOptions.data.length=0,c()},function(e){}):n.notify(l.UpdatedSuccessfully,{type:"success"}).then(function(){s.gridOptions.data.length=0,c()},function(e){})},function(e){t.resolve(),n.notify(e.errors.join("<br/>"),{autoClose:!1,type:"danger"})}),s.assignMetricRow=[]},s.gridOptions.onRegisterApi=function(e){s.gridApi=e,e.rowEdit.on.saveRow(a,s.saveRow)};(function(){s.getLookupData(),c()})()}])});