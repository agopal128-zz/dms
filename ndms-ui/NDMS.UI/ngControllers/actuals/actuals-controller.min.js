"use strict";define(["angularAMD","rangeSlider","actualsService","ionSlider","counterMeasureController","metricType"],function(a){a.controller("ActualsController",["configService","validationService","notificationService","confirmationModalService","actualsService","$scope","$uibModal","$uibModalInstance","modalData","$filter","$location","$timeout",function(a,t,e,i,r,c,l,n,u,o,d,s){var m=this,y=u.date;m.metricData={},m.metricData=u,m.metricData.outstandingCounterMeasureExists=!1,m.inputMinValue=0,m.sliderMinValue=0,m.actualEntered=0,m.sliderMaxValue=0,m.sliderFromValue=0,m.isShowingActualPopup=!0,m.changedValues={},m.isActualSaveDisabled=!1,m.hasGoalValue=!1;var D=a.getUIResources("Actuals"),g=function(){m.metricData.isMonthlyTracking===!0&&m.metricData.isPrimary===!0?m.metricData.date=o("date")(m.metricData.date,"MMMM, y"):m.metricData.isPrimary===!0&&(m.metricData.date=o("date")(m.metricData.date,"fullDate")),2===m.metricData.metricDataTypeId?m.isSliderEnabled=!0:m.isSliderEnabled=!1,3===m.metricData.status?m.actionForHoliday="Mark as Workday":m.actionForHoliday="Mark as Non-Workday",3==m.metricData.metricDataTypeId&&(m.inputMinValue=""),null!==m.metricData.goalValue&&""!==m.metricData.goalValue&&(m.hasGoalValue=!0)},h=function(){2===m.metricData.metricDataTypeId?m.sliderMaxValue=100:m.metricData.goalValue&&(m.sliderMaxValue=m.metricData.goalValue),m.metricData.currentActual||0===m.metricData.currentActual?(m.sliderFromValue=m.metricData.currentActual,m.actualEntered=m.metricData.currentActual):(m.sliderFromValue=m.metricData.goalValue,m.actualEntered=m.metricData.goalValue)},M=function(a){0==m.metricData.metricDataTypeId&&null!=a.actualValue&&(a.actualValue=Math.floor(a.actualValue)),r.addActuals(a).then(function(a){m.isTargetAchieved&&(m.isActualSaveDisabled=!1,e.notify(D.AddedSuccessfully,{type:"success",timeout:500}).then(function(){})),m.changedValues.id=a,n.close(m.changedValues)},function(a){m.isActualSaveDisabled=!1,e.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},f=function(a){0==m.metricData.metricDataTypeId&&null!=a.actualValue&&(a.actualValue=Math.floor(a.actualValue)),r.updateActuals(a).then(function(a){m.isTargetAchieved&&(m.isActualSaveDisabled=!1,e.notify(D.AddedSuccessfully,{type:"success",timeout:500}).then(function(){})),n.close(m.changedValues)},function(a){m.isActualSaveDisabled=!1,e.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},p=function(a){var t={id:m.metricData.id,scorecardId:m.metricData.scorecardId,targetId:m.metricData.targetId,date:o("date")(y,"dd MMM yyyy"),actualValue:m.actualEntered,goalValue:m.metricData.goalValue};e.close(),t.actualValue=Math.round(100*t.actualValue)/100,m.changedValues={id:m.metricData.id,newActual:t.actualValue,day:m.metricData.day,status:a,month:m.metricData.month,isMonthlyTracking:m.metricData.isMonthlyTracking,isPrimary:m.metricData.isPrimary,targetId:m.metricData.targetId,targetEntryMethodId:m.metricData.targetEntryMethodId,dailyRate:m.metricData.dailyRate,graphPlottingMethodId:m.metricData.graphPlottingMethodId},m.metricData.id||0===m.metricData.id?f(t):M(t)};m.save=function(){e.close();var a=[];if(angular.isUndefined(m.actualEntered)?a.push(D.InvalidActual):m.actualEntered||0===m.actualEntered||a.push(D.RequiredActual),a.length)m.isActualSaveDisabled=!1,e.notify(a.join("<br/>"),{autoClose:!1,type:"danger"});else{var t={targetId:m.metricData.targetId,goalValue:m.metricData.goalValue,actualValue:m.actualEntered,selectedDate:o("date")(m.metricData.date,"dd MMM yyyy")};r.getActualStatusandCounterMeasure(t).then(function(a){a&&(m.metricData.outstandingCounterMeasureExists=a.outstandingCounterMeasureExists,2===a.actualStatus?V(a.actualStatus):1!==a.actualStatus&&0!==a.actualStatus||(m.isTargetAchieved=!0,p(a.actualStatus)))},function(a){m.isActualSaveDisabled=!1,e.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})}};var V=function(a){l.open({templateUrl:"ngViews/counter-measure/partials/counter-measure-popup.min.html",controller:"counterMeasureController",controllerUrl:"ngControllers/counter-measure/counter-measure-controller.min",controllerAs:"ctrl",windowClass:"counter-measure-popup",backdrop:"static",keyboard:!1,resolve:{actualData:function(){return m.metricData},counterMeasure:function(){},metricDetails:function(){}}}).result.then(function(t){p(a),m.isActualSaveDisabled=!1},function(){m.isActualSaveDisabled=!1})};m.updateSlider=function(a){a>m.sliderMaxValue?m.sliderFromValue=m.sliderMaxValue:m.sliderFromValue=a},m.updateInput=function(a){c.changedSliderValue=a.from,a&&(c.$$phase||c.$apply(function(){m.actualEntered=a.from}))},m.markHoliday=function(a){if(3==a){var t="";t=0==m.metricData.targetEntryMethodId?D.DailyRateMsg+" "+m.metricData.dailyRate+D.DailyRateProceedMsg:D.MarkasWorkdayMsg;var c=i.openConfirmationModal("md",t);c.result.then(function(){e.close(),m.changedValues={id:m.metricData.id,newActual:null,day:m.metricData.day,status:3==a?0:3,month:m.metricData.month,isMonthlyTracking:m.metricData.isMonthlyTracking,isPrimary:m.metricData.isPrimary,targetId:m.metricData.targetId,targetEntryMethodId:m.metricData.targetEntryMethodId,dailyRate:m.metricData.dailyRate,graphPlottingMethodId:m.metricData.graphPlottingMethodId};var t=o("date")(y,"dd MMM yyyy");r.changeHoliday(m.metricData.scorecardId,m.metricData.targetId,t,a).then(function(a){m.isActualSaveDisabled=!1,e.notify(D.MarkedSuccessfully,{type:"success",timeout:500}).then(function(){a&&(m.changedValues.id=a),n.close(m.changedValues)})},function(a){m.isActualSaveDisabled=!1,e.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},function(){})}else if(0!=m.metricData.targetEntryMethodId){var c=i.openConfirmationModal("md",D.MarkasWorkdayMsg);c.result.then(function(){e.close(),m.changedValues={id:m.metricData.id,newActual:null,day:m.metricData.day,status:3==a?0:3,month:m.metricData.month,isMonthlyTracking:m.metricData.isMonthlyTracking,isPrimary:m.metricData.isPrimary,targetId:m.metricData.targetId,dailyRate:m.metricData.dailyRate,targetEntryMethodId:m.metricData.targetEntryMethodId,graphPlottingMethodId:m.metricData.graphPlottingMethodId};var t=o("date")(y,"dd MMM yyyy");r.changeHoliday(m.metricData.scorecardId,m.metricData.targetId,t,a).then(function(a){m.isActualSaveDisabled=!1,e.notify(D.MarkedSuccessfully,{type:"success",timeout:500}).then(function(){a&&(m.changedValues.id=a),n.close(m.changedValues)})},function(a){m.isActualSaveDisabled=!1,e.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})},function(){})}else{e.close(),m.changedValues={id:m.metricData.id,newActual:null,day:m.metricData.day,status:3==a?0:3,month:m.metricData.month,isMonthlyTracking:m.metricData.isMonthlyTracking,isPrimary:m.metricData.isPrimary,targetId:m.metricData.targetId,dailyRate:m.metricData.dailyRate,targetEntryMethodId:m.metricData.targetEntryMethodId,graphPlottingMethodId:m.metricData.graphPlottingMethodId};var l=o("date")(y,"dd MMM yyyy");r.changeHoliday(m.metricData.scorecardId,m.metricData.targetId,l,a).then(function(a){m.isActualSaveDisabled=!1,e.notify(D.MarkedSuccessfully,{type:"success",timeout:500}).then(function(){a&&(m.changedValues.id=a),n.close(m.changedValues)})},function(a){m.isActualSaveDisabled=!1,e.notify(a.errors.join("<br/>"),{autoClose:!1,type:"danger"})})}},m.cancel=function(){e.close(),m.isActualSaveDisabled=!1,n.dismiss("cancel")};(function(){g(),h()})()}])});